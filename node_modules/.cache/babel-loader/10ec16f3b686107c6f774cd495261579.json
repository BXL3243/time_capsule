{"ast":null,"code":"import _regeneratorRuntime from\"/Users/richard/Downloads/crypto-capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/richard/Downloads/crypto-capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import abi from\"../data/aggregatorV3InterfaceABI.json\";import{getGlobals}from\"../utils/globals\";export var getOracleContract=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(oracle){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",new window.web3.eth.Contract(abi,oracle));case 1:case\"end\":return _context.stop();}}},_callee);}));return function getOracleContract(_x){return _ref.apply(this,arguments);};}();export var getOracle=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(token){var globals,oracles;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getGlobals();case 2:globals=_context2.sent;oracles=globals.ORACLES.filter(function(o){return o.token===token;});if(!(oracles.length===0)){_context2.next=6;break;}return _context2.abrupt(\"return\",\"\");case 6:return _context2.abrupt(\"return\",oracles[0].oracle);case 7:case\"end\":return _context2.stop();}}},_callee2);}));return function getOracle(_x2){return _ref2.apply(this,arguments);};}();export var getTokenPriceInUsd=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(token){var oracle,oracleContract,roundData;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return getOracle(token);case 2:oracle=_context3.sent;if(oracle){_context3.next=5;break;}return _context3.abrupt(\"return\",0);case 5:_context3.next=7;return getOracleContract(oracle);case 7:oracleContract=_context3.sent;_context3.next=10;return oracleContract.methods.latestRoundData().call();case 10:roundData=_context3.sent;return _context3.abrupt(\"return\",roundData.answer/Math.pow(10,8));case 12:case\"end\":return _context3.stop();}}},_callee3);}));return function getTokenPriceInUsd(_x3){return _ref3.apply(this,arguments);};}();export var getTokenValueInUsd=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(token,amount){var price;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return getTokenPriceInUsd(token);case 2:price=_context4.sent;return _context4.abrupt(\"return\",amount*price);case 4:case\"end\":return _context4.stop();}}},_callee4);}));return function getTokenValueInUsd(_x4,_x5){return _ref4.apply(this,arguments);};}();export var getCapsuleUsdValue=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(capsule){var usds,promises;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:usds=[];promises=capsule.assets.map(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(asset){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.t0=usds;_context5.next=3;return getTokenValueInUsd(asset.token,Number(asset.value)/Math.pow(10,18));case 3:_context5.t1=_context5.sent;return _context5.abrupt(\"return\",_context5.t0.push.call(_context5.t0,_context5.t1));case 5:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x7){return _ref6.apply(this,arguments);};}());_context6.next=4;return Promise.all(promises);case 4:return _context6.abrupt(\"return\",usds.reduce(function(a,b){return a+b;},0));case 5:case\"end\":return _context6.stop();}}},_callee6);}));return function getCapsuleUsdValue(_x6){return _ref5.apply(this,arguments);};}();","map":{"version":3,"sources":["/Users/richard/Downloads/crypto-capsule/client/src/services/oracleService.ts"],"names":["abi","getGlobals","getOracleContract","oracle","window","web3","eth","Contract","getOracle","token","globals","oracles","ORACLES","filter","o","length","getTokenPriceInUsd","oracleContract","methods","latestRoundData","call","roundData","answer","getTokenValueInUsd","amount","price","getCapsuleUsdValue","capsule","usds","promises","assets","map","asset","Number","value","push","Promise","all","reduce","a","b"],"mappings":"uUACA,MAAOA,CAAAA,GAAP,KAAgB,uCAAhB,CAGA,OAASC,UAAT,KAA2B,kBAA3B,CAUA,MAAO,IAAMC,CAAAA,iBAAiB,0FAAG,iBAAOC,MAAP,kJACxB,GAAKC,CAAAA,MAAD,CAAgBC,IAAhB,CAAqBC,GAArB,CAAyBC,QAA7B,CAAsCP,GAAtC,CAA2CG,MAA3C,CADwB,wDAAH,kBAAjBD,CAAAA,iBAAiB,4CAAvB,CAIP,MAAO,IAAMM,CAAAA,SAAS,2FAAG,kBAAOC,KAAP,iKACDR,CAAAA,UAAU,EADT,QACjBS,OADiB,gBAEjBC,OAFiB,CAEPD,OAAO,CAACE,OAAR,CAAgBC,MAAhB,CAAuB,SAACC,CAAD,QAAmBA,CAAAA,CAAC,CAACL,KAAF,GAAYA,KAA/B,EAAvB,CAFO,MAGnBE,OAAO,CAACI,MAAR,GAAmB,CAHA,4DAGU,EAHV,0CAIhBJ,OAAO,CAAC,CAAD,CAAP,CAAWR,MAJK,0DAAH,kBAATK,CAAAA,SAAS,8CAAf,CAOP,MAAO,IAAMQ,CAAAA,kBAAkB,2FAAG,kBAAOP,KAAP,iLACXD,CAAAA,SAAS,CAACC,KAAD,CADE,QAC1BN,MAD0B,mBAE3BA,MAF2B,2DAEZ,CAFY,gCAGHD,CAAAA,iBAAiB,CAACC,MAAD,CAHd,QAG1Bc,cAH0B,wCAIOA,CAAAA,cAAc,CAACC,OAAf,CACpCC,eADoC,GAEpCC,IAFoC,EAJP,SAI1BC,SAJ0B,iDAOzBA,SAAS,CAACC,MAAV,UAAmB,EAAnB,CAAyB,CAAzB,CAPyB,2DAAH,kBAAlBN,CAAAA,kBAAkB,8CAAxB,CAUP,MAAO,IAAMO,CAAAA,kBAAkB,2FAAG,kBAChCd,KADgC,CAEhCe,MAFgC,uJAIZR,CAAAA,kBAAkB,CAACP,KAAD,CAJN,QAI1BgB,KAJ0B,iDAKzBD,MAAM,CAAGC,KALgB,0DAAH,kBAAlBF,CAAAA,kBAAkB,kDAAxB,CAQP,MAAO,IAAMG,CAAAA,kBAAkB,2FAAG,kBAChCC,OADgC,wIAG1BC,IAH0B,CAGT,EAHS,CAI1BC,QAJ0B,CAIfF,OAAO,CAACG,MAAR,CAAeC,GAAf,2FAAmB,kBAAOC,KAAP,mIAClCJ,IADkC,wBAE1BL,CAAAA,kBAAkB,CAACS,KAAK,CAACvB,KAAP,CAAcwB,MAAM,CAACD,KAAK,CAACE,KAAP,CAAN,UAAsB,EAAtB,CAA4B,EAA5B,CAAd,CAFQ,kFAC7BC,IAD6B,0FAAnB,iEAJe,wBAS1BC,CAAAA,OAAO,CAACC,GAAR,CAAYR,QAAZ,CAT0B,yCAUzBD,IAAI,CAACU,MAAL,CAAY,SAACC,CAAD,CAAYC,CAAZ,QAA0BD,CAAAA,CAAC,CAAGC,CAA9B,EAAZ,CAA6C,CAA7C,CAVyB,0DAAH,kBAAlBd,CAAAA,kBAAkB,8CAAxB","sourcesContent":["import { Contract } from \"web3-eth-contract\";\nimport abi from \"../data/aggregatorV3InterfaceABI.json\";\nimport CapsuleType, { Asset } from \"../types/CapsuleType\";\nimport { OracleType } from \"../data/oracles\";\nimport { getGlobals } from \"../utils/globals\";\n\ntype RoundDataType = {\n  roundId: number;\n  answer: number;\n  startedAt: number;\n  updatedAt: number;\n  answeredInRound: number;\n};\n\nexport const getOracleContract = async (oracle: string): Promise<Contract> => {\n  return new (window as any).web3.eth.Contract(abi, oracle);\n};\n\nexport const getOracle = async (token: string): Promise<string> => {\n  const globals = await getGlobals();\n  const oracles = globals.ORACLES.filter((o: OracleType) => o.token === token);\n  if (oracles.length === 0) return \"\";\n  return oracles[0].oracle;\n};\n\nexport const getTokenPriceInUsd = async (token: string): Promise<number> => {\n  const oracle = await getOracle(token);\n  if (!oracle) return 0;\n  const oracleContract = await getOracleContract(oracle);\n  const roundData: RoundDataType = await oracleContract.methods\n    .latestRoundData()\n    .call();\n  return roundData.answer / 10 ** 8;\n};\n\nexport const getTokenValueInUsd = async (\n  token: string,\n  amount: number\n): Promise<number> => {\n  const price = await getTokenPriceInUsd(token);\n  return amount * price;\n};\n\nexport const getCapsuleUsdValue = async (\n  capsule: CapsuleType\n): Promise<number> => {\n  const usds: number[] = [];\n  const promises = capsule.assets.map(async (asset: Asset) =>\n    usds.push(\n      await getTokenValueInUsd(asset.token, Number(asset.value) / 10 ** 18)\n    )\n  );\n  await Promise.all(promises);\n  return usds.reduce((a: number, b: number) => a + b, 0);\n};\n"]},"metadata":{},"sourceType":"module"}