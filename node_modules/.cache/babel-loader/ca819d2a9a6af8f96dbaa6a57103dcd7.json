{"ast":null,"code":"import Web3 from \"web3\";\nimport BN from \"bn.js\";\nimport capsuleAbi from \"../contracts/CryptoCapsule.json\";\nimport tokenAbi from \"../contracts/ERC20.json\";\nimport { toEthUnit } from \"./web3Service\";\nimport { dateToUnix, getPeriodType, UnixToDate } from \"./dateHelper\";\nimport { getGlobals } from \"../utils/globals\"; // Shared\n\nexport const isConnected = () => {\n  return window.web3.eth;\n};\nexport const getAddress = async () => {\n  if (window.ethereum) {\n    window.web3 = new Web3(window.ethereum);\n    window.ethereum.enable();\n    const addressList = await window.web3.eth.getAccounts();\n    return addressList[0];\n  }\n\n  return \"\";\n};\nexport const getCapsuleContract = async () => {\n  const globals = await getGlobals();\n  return new window.web3.eth.Contract(capsuleAbi, globals.CAPSULE, {\n    from: await getAddress()\n  });\n};\nexport const getTokenContract = async token => {\n  return new window.web3.eth.Contract(tokenAbi, token, {\n    from: await getAddress()\n  });\n}; // Functions\n\nexport const createCapsule = async (beneficiary, distributionDate, periodSize, periodCount, assets, addingAssetsAllowed) => {\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const ethAssets = assets.filter(a => a.token === \"ETH\");\n  const eth = ethAssets.length === 1 ? ethAssets[0].value : 0;\n  const otherAssets = assets.filter(a => a.token !== \"ETH\");\n  const tx = {\n    from: address,\n    value: eth\n  };\n  await capsuleContract.methods.createCapsule(beneficiary, dateToUnix(distributionDate), periodSize, periodCount, otherAssets.map(a => a.token), otherAssets.map(a => a.value), addingAssetsAllowed).send(tx);\n};\nexport const openCapsule = async capsuleId => {\n  const capsuleContract = await getCapsuleContract();\n  await capsuleContract.methods.openCapsule(new BN(capsuleId)).send();\n};\nexport const addAssets = async (capsuleId, assets) => {\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const ethAssets = assets.filter(a => a.token === \"ETH\");\n  const eth = ethAssets.length === 1 ? ethAssets[0].value : 0;\n  const otherAssets = assets.filter(a => a.token !== \"ETH\");\n  const tx = {\n    from: address,\n    value: eth\n  };\n  await capsuleContract.methods.addAssets(capsuleId, otherAssets.map(a => a.token), otherAssets.map(a => a.value)).send(tx);\n};\nexport const updateBeneficiary = async (capsuleId, beneficiary) => {\n  const capsuleContract = await getCapsuleContract();\n  await capsuleContract.methods.updateBeneficiary(capsuleId, beneficiary).send();\n}; // Views\n\nexport const getCapsule = async (capsuleId) => {\n  if (!isConnected()) return null;\n  const capsuleContract = await getCapsuleContract();\n  const response = await capsuleContract.methods.getCapsule(capsuleId).call();\n  return responseToCapsule(response);\n};\nexport const getSentCapsules = async () => {\n  if (!isConnected()) return [];\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const response = await capsuleContract.methods.getSentCapsules(address).call();\n  return response.map(rc => responseToCapsule(rc));\n};\nexport const getReceivedCapsules = async () => {\n  if (!isConnected()) return [];\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const response = await capsuleContract.methods.getReceivedCapsules(address).call();\n  return response.map(rc => responseToCapsule(rc));\n}; // Utils\n\nexport const responseToCapsule = capsule => {\n  const assets = [];\n  const eth = toEthUnit(new BN(capsule.value));\n  if (eth > 0) assets.push({\n    token: \"ETH\",\n    value: capsule.value\n  });\n\n  for (let i = 0; i < capsule.tokens.length; i++) {\n    assets.push({\n      token: capsule.tokens[i],\n      value: capsule.amounts[i]\n    });\n  }\n\n  return {\n    id: Number(capsule.id),\n    beneficiary: capsule.beneficiary,\n    grantor: capsule.grantor,\n    empty: capsule.empty,\n    createdDate: UnixToDate(Number.parseFloat(capsule.createdDate)),\n    distributionDate: UnixToDate(Number.parseFloat(capsule.distributionDate)),\n    periodType: getPeriodType(capsule.periodSize),\n    periodCount: Number(capsule.periodCount),\n    claimedPeriods: Number(capsule.claimedPeriods),\n    assets,\n    addingAssetsAllowed: capsule.addingAssetsAllowed\n  };\n};\nexport const ethBalance = async () => {\n  const address = await getAddress();\n  const wei = await window.web3.eth.getBalance(address);\n  return toEthUnit(wei);\n}; // Tokens\n\nexport const approveToken = async token => {\n  const globals = await getGlobals();\n  const tokenContract = await getTokenContract(token);\n  await tokenContract.methods.approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\")).send();\n};\nexport const tokenApproved = async token => {\n  if (token === \"ETH\") return true;\n  const globals = await getGlobals();\n  const address = await getAddress();\n  const tokenContract = await getTokenContract(token);\n  const allowance = await tokenContract.methods.allowance(address, globals.CAPSULE).call();\n  return new BN(allowance).gt(new BN(\"9999999999999999999999\"));\n};\nexport const tokenBalance = async token => {\n  const address = await getAddress();\n  const tokenContract = await getTokenContract(token.address);\n  const cents = await tokenContract.methods.balanceOf(address).call();\n  return cents / 10 ** token.decimals;\n};\nexport const getAssetSymbol = async token => {\n  if (token.toLocaleLowerCase() === \"eth\") return \"ETH\";\n  const tokenContract = await getTokenContract(token);\n  return tokenContract.methods.symbol().call();\n};\nexport const getAssetDecimals = async token => {\n  if (token.toLocaleLowerCase() === \"eth\") return 18;\n  const tokenContract = await getTokenContract(token);\n  return tokenContract.methods.decimals().call();\n};\nexport const getAssetRealValue = async asset => {\n  if (asset.value === \"0\") return 0;\n  const decimals = await getAssetDecimals(asset.token);\n  return Number(asset.value) / 10 ** decimals;\n};\nexport const getAssetLongValue = async (value, token) => {\n  if (value === 0) return \"0\";\n  const decimals = await getAssetDecimals(token);\n  return Math.round(value * 10 ** decimals).toString();\n};","map":{"version":3,"sources":["/Users/richard/Downloads/crypto-capsule/client/src/services/contracthelper.ts"],"names":["Web3","BN","capsuleAbi","tokenAbi","toEthUnit","dateToUnix","getPeriodType","UnixToDate","getGlobals","isConnected","window","web3","eth","getAddress","ethereum","enable","addressList","getAccounts","getCapsuleContract","globals","Contract","CAPSULE","from","getTokenContract","token","createCapsule","beneficiary","distributionDate","periodSize","periodCount","assets","addingAssetsAllowed","address","capsuleContract","ethAssets","filter","a","length","value","otherAssets","tx","methods","map","send","openCapsule","capsuleId","addAssets","updateBeneficiary","getCapsule","response","call","responseToCapsule","getSentCapsules","rc","getReceivedCapsules","capsule","push","i","tokens","amounts","id","Number","grantor","empty","createdDate","parseFloat","periodType","claimedPeriods","ethBalance","wei","getBalance","approveToken","tokenContract","approve","tokenApproved","allowance","gt","tokenBalance","cents","balanceOf","decimals","getAssetSymbol","toLocaleLowerCase","symbol","getAssetDecimals","getAssetRealValue","asset","getAssetLongValue","Math","round","toString"],"mappings":"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","sourcesContent":["import { Contract } from \"web3-eth-contract\";\nimport Web3 from \"web3\";\nimport BN from \"bn.js\";\nimport capsuleAbi from \"../contracts/CryptoCapsule.json\";\nimport tokenAbi from \"../contracts/ERC20.json\";\nimport { toEthUnit } from \"./web3Service\";\nimport { dateToUnix, getPeriodType, UnixToDate } from \"./dateHelper\";\nimport CapsuleType, { Asset } from \"../types/CapsuleType\";\nimport ContractCapsuleType from \"../types/ContractCapsuleType\";\nimport Token from \"../types/Token\";\nimport { getGlobals } from \"../utils/globals\";\n\n// Shared\nexport const isConnected = (): boolean => {\n  return (window as any).web3.eth;\n};\n\nexport const getAddress = async (): Promise<string> => {\n  if ((window as any).ethereum) {\n    (window as any).web3 = new Web3((window as any).ethereum);\n    (window as any).ethereum.enable();\n    const addressList = await (window as any).web3.eth.getAccounts();\n    return addressList[0];\n  }\n  return \"\";\n};\n\nexport const getCapsuleContract = async (): Promise<Contract> => {\n  const globals = await getGlobals();\n  return new (window as any).web3.eth.Contract(capsuleAbi, globals.CAPSULE, {\n    from: await getAddress(),\n  });\n};\n\nexport const getTokenContract = async (token: string): Promise<Contract> => {\n  return new (window as any).web3.eth.Contract(tokenAbi, token, {\n    from: await getAddress(),\n  });\n};\n\n// Functions\nexport const createCapsule = async (\n  beneficiary: string,\n  distributionDate: Date,\n  periodSize: number,\n  periodCount: number,\n  assets: Asset[],\n  addingAssetsAllowed: boolean\n): Promise<void> => {\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n\n  const ethAssets = assets.filter((a: Asset) => a.token === \"ETH\");\n  const eth = ethAssets.length === 1 ? ethAssets[0].value : 0;\n  const otherAssets = assets.filter((a: Asset) => a.token !== \"ETH\");\n\n  const tx = {\n    from: address,\n    value: eth,\n  };\n  await capsuleContract.methods\n    .createCapsule(\n      beneficiary,\n      dateToUnix(distributionDate),\n      periodSize,\n      periodCount,\n      otherAssets.map((a: Asset) => a.token),\n      otherAssets.map((a: Asset) => a.value),\n      addingAssetsAllowed\n    )\n    .send(tx);\n};\n\nexport const openCapsule = async (capsuleId: number): Promise<void> => {\n  const capsuleContract = await getCapsuleContract();\n  await capsuleContract.methods.openCapsule(new BN(capsuleId)).send();\n};\n\nexport const addAssets = async (\n  capsuleId: number,\n  assets: Asset[]\n): Promise<void> => {\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n\n  const ethAssets = assets.filter((a: Asset) => a.token === \"ETH\");\n  const eth = ethAssets.length === 1 ? ethAssets[0].value : 0;\n  const otherAssets = assets.filter((a: Asset) => a.token !== \"ETH\");\n\n  const tx = {\n    from: address,\n    value: eth,\n  };\n  await capsuleContract.methods\n    .addAssets(\n      capsuleId,\n      otherAssets.map((a: Asset) => a.token),\n      otherAssets.map((a: Asset) => a.value)\n    )\n    .send(tx);\n};\n\nexport const updateBeneficiary = async (\n  capsuleId: number,\n  beneficiary: string\n): Promise<void> => {\n  const capsuleContract = await getCapsuleContract();\n  await capsuleContract.methods\n    .updateBeneficiary(capsuleId, beneficiary)\n    .send();\n};\n\n// Views\nexport const getCapsule = async (\n  capsuleId: number\n): Promise<CapsuleType | null> => {\n  if (!isConnected()) return null;\n  const capsuleContract = await getCapsuleContract();\n  const response: ContractCapsuleType = await capsuleContract.methods\n    .getCapsule(capsuleId)\n    .call();\n  return responseToCapsule(response);\n};\n\nexport const getSentCapsules = async (): Promise<CapsuleType[]> => {\n  if (!isConnected()) return [];\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const response: ContractCapsuleType[] = await capsuleContract.methods\n    .getSentCapsules(address)\n    .call();\n  return response.map((rc: ContractCapsuleType) => responseToCapsule(rc));\n};\n\nexport const getReceivedCapsules = async (): Promise<CapsuleType[]> => {\n  if (!isConnected()) return [];\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const response: ContractCapsuleType[] = await capsuleContract.methods\n    .getReceivedCapsules(address)\n    .call();\n  return response.map((rc: ContractCapsuleType) => responseToCapsule(rc));\n};\n\n// Utils\nexport const responseToCapsule = (\n  capsule: ContractCapsuleType\n): CapsuleType => {\n  const assets: Asset[] = [];\n  const eth = toEthUnit(new BN(capsule.value));\n  if (eth > 0) assets.push({ token: \"ETH\", value: capsule.value });\n  for (let i = 0; i < capsule.tokens.length; i++) {\n    assets.push({\n      token: capsule.tokens[i],\n      value: capsule.amounts[i],\n    });\n  }\n\n  return {\n    id: Number(capsule.id),\n    beneficiary: capsule.beneficiary,\n    grantor: capsule.grantor,\n    empty: capsule.empty,\n    createdDate: UnixToDate(Number.parseFloat(capsule.createdDate)),\n    distributionDate: UnixToDate(Number.parseFloat(capsule.distributionDate)),\n    periodType: getPeriodType(capsule.periodSize),\n    periodCount: Number(capsule.periodCount),\n    claimedPeriods: Number(capsule.claimedPeriods),\n    assets,\n    addingAssetsAllowed: capsule.addingAssetsAllowed,\n  };\n};\n\nexport const ethBalance = async (): Promise<number> => {\n  const address = await getAddress();\n  const wei = await window.web3.eth.getBalance(address);\n  return toEthUnit(wei);\n};\n\n// Tokens\nexport const approveToken = async (token: string): Promise<void> => {\n  const globals = await getGlobals();\n  const tokenContract = await getTokenContract(token);\n  await tokenContract.methods\n    .approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\"))\n    .send();\n};\n\nexport const tokenApproved = async (token: string): Promise<boolean> => {\n  if (token === \"ETH\") return true;\n  const globals = await getGlobals();\n  const address = await getAddress();\n  const tokenContract = await getTokenContract(token);\n  const allowance = await tokenContract.methods\n    .allowance(address, globals.CAPSULE)\n    .call();\n  return new BN(allowance).gt(new BN(\"9999999999999999999999\"));\n};\n\nexport const tokenBalance = async (token: Token): Promise<number> => {\n  const address = await getAddress();\n  const tokenContract = await getTokenContract(token.address);\n  const cents = await tokenContract.methods.balanceOf(address).call();\n  return cents / 10 ** token.decimals;\n};\n\nexport const getAssetSymbol = async (token: string): Promise<string> => {\n  if (token.toLocaleLowerCase() === \"eth\") return \"ETH\";\n  const tokenContract = await getTokenContract(token);\n  return tokenContract.methods.symbol().call();\n};\n\nexport const getAssetDecimals = async (token: string): Promise<number> => {\n  if (token.toLocaleLowerCase() === \"eth\") return 18;\n  const tokenContract = await getTokenContract(token);\n  return tokenContract.methods.decimals().call();\n};\n\nexport const getAssetRealValue = async (asset: Asset): Promise<number> => {\n  if (asset.value === \"0\") return 0;\n  const decimals = await getAssetDecimals(asset.token);\n  return Number(asset.value) / 10 ** decimals;\n};\n\nexport const getAssetLongValue = async (\n  value: number,\n  token: string\n): Promise<string> => {\n  if (value === 0) return \"0\";\n  const decimals = await getAssetDecimals(token);\n  return Math.round(value * 10 ** decimals).toString();\n};\n"]},"metadata":{},"sourceType":"module"}