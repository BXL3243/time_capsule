{"ast":null,"code":"import _regeneratorRuntime from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _taggedTemplateLiteral from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral\";var _templateObject,_templateObject2;import React,{useState}from\"react\";import crypto from\"crypto\";import copy from\"copy-to-clipboard\";import BN from\"bn.js\";import{useSelector}from\"react-redux\";import styled from\"styled-components\";import{useHistory}from\"react-router\";import{gtag}from\"@deptno/gtag\";import lockedCapsule from\"../assets/capsule-locked-large.png\";import{createCapsule,getAssetLongValue,getTokenContract,tokenApproved}from\"../services/contracthelper\";import{getPeriodSize,inputToDate}from\"../services/dateHelper\";import{selectTokens}from\"../state/tokenSlice\";import Assets from\"./Assets\";import TextInput from\"./TextInput\";import Popup from\"./Popup\";import{ValidationError}from\"../styles/ValidationError\";import Selector from\"./Selector\";import Dropdown from\"./Dropdown\";import{getGlobals}from\"../utils/globals\";import Button from\"./Button\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var Content=styled.div(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  width: 100%;\\n  display: flex;\\n  flex-direction: column;\\n\"])));var ButtonContainer=styled.div(_templateObject2||(_templateObject2=_taggedTemplateLiteral([\"\\n  margin-top: 2rem;\\n  display: flex;\\n\\n  button {\\n    margin: 0 1rem;\\n  }\\n\\n  @media (max-width: 768px) {\\n    flex-direction: column;\\n\\n    button {\\n      margin: 1rem 0;\\n    }\\n  }\\n\"])));var CreateCapsule=function CreateCapsule(props){if(!props.show)return/*#__PURE__*/_jsx(_Fragment,{});var history=useHistory();var ethAsset={token:\"ETH\",value:\"0\"};var approval={asset:ethAsset,approved:true};var _useState=useState(false),_useState2=_slicedToArray(_useState,2),loading=_useState2[0],setLoading=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),complete=_useState4[0],setComplete=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),messagePasswordCopyState=_useState6[0],setMessagePasswordCopyState=_useState6[1];var _useState7=useState(\"\"),_useState8=_slicedToArray(_useState7,2),beneficiary=_useState8[0],setBeneficiary=_useState8[1];var _useState9=useState(\"\"),_useState10=_slicedToArray(_useState9,2),message=_useState10[0],setMessage=_useState10[1];var _useState11=useState(\"\"),_useState12=_slicedToArray(_useState11,2),distributionDate=_useState12[0],setDistributionDate=_useState12[1];var _useState13=useState(\"\"),_useState14=_slicedToArray(_useState13,2),messagePassword=_useState14[0],setMessagePassword=_useState14[1];var _useState15=useState(\"immediate\"),_useState16=_slicedToArray(_useState15,2),periodType=_useState16[0],setPeriodType=_useState16[1];var _useState17=useState(\"monthly\"),_useState18=_slicedToArray(_useState17,2),distributionFrequency=_useState18[0],setDistributionFrequency=_useState18[1];var _useState19=useState(\"\"),_useState20=_slicedToArray(_useState19,2),distributionPeriods=_useState20[0],setDistributionPeriods=_useState20[1];var _useState21=useState(\"\"),_useState22=_slicedToArray(_useState21,2),distributionDateError=_useState22[0],setDistributionDateError=_useState22[1];var _useState23=useState(\"yes\"),_useState24=_slicedToArray(_useState23,2),addingAssetsAllowed=_useState24[0],setAddingAssetsAllowed=_useState24[1];var _useState25=useState(\"\"),_useState26=_slicedToArray(_useState25,2),addressError=_useState26[0],setAddressError=_useState26[1];var _useState27=useState(\"\"),_useState28=_slicedToArray(_useState27,2),messageError=_useState28[0],setMessageError=_useState28[1];var _useState29=useState(\"\"),_useState30=_slicedToArray(_useState29,2),messageCopyError=_useState30[0],setMessageCopyError=_useState30[1];var _useState31=useState(\"\"),_useState32=_slicedToArray(_useState31,2),distributionPeriodsError=_useState32[0],setDistributionPeriodsError=_useState32[1];var _useState33=useState([ethAsset]),_useState34=_slicedToArray(_useState33,2),assets=_useState34[0],_setAssets=_useState34[1];var _useState35=useState([approval]),_useState36=_slicedToArray(_useState35,2),approvals=_useState36[0],setApprovals=_useState36[1];var tokens=useSelector(selectTokens);var unapproved=approvals.filter(function(a){return!a.approved;});var addressSymbol=function addressSymbol(address){return tokens.filter(function(token){return token.address===address;})[0].symbol;};var updateApprovals=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(assets){var _approvals,promises;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_approvals=[];promises=assets.map(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(asset){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.t0=_approvals;_context.t1=asset;_context.next=4;return tokenApproved(asset.token);case 4:_context.t2=_context.sent;_context.t3={asset:_context.t1,approved:_context.t2};_context.t0.push.call(_context.t0,_context.t3);case 7:case\"end\":return _context.stop();}}},_callee);}));return function(_x2){return _ref2.apply(this,arguments);};}());_context2.next=4;return Promise.all(promises);case 4:setApprovals(_approvals);case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function updateApprovals(_x){return _ref.apply(this,arguments);};}();var tokenApprove=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(address){var globals,tokenContract;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return getGlobals();case 2:globals=_context4.sent;_context4.next=5;return getTokenContract(address);case 5:tokenContract=_context4.sent;tokenContract.methods.approve(globals.CAPSULE,new BN(\"9999999999999999999999999999\")).send().on(\"transactionHash\",function(hash){setLoading(true);}).on(\"receipt\",/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(receipt){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return updateApprovals(assets);case 2:setLoading(false);case 3:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x4){return _ref4.apply(this,arguments);};}()).on(\"error\",function(err){console.log(\"Error: \".concat(err));setLoading(false);});case 7:case\"end\":return _context4.stop();}}},_callee4);}));return function tokenApprove(_x3){return _ref3.apply(this,arguments);};}();var aesEncrypt=function aesEncrypt(value,key){if(value===\"\")return\"\";var encValue=escape(value);var cipher=crypto.createCipheriv(\"aes-128-cbc\",key.slice(0,16),key.slice(16));var crypted=cipher.update(encValue,\"utf8\",\"hex\");crypted+=cipher.final(\"hex\");return crypted;};var getMD5=function getMD5(value){var hash=crypto.createHash(\"md5\");hash.update(value);return hash.digest(\"hex\");// 7e1977739c748beac0c0fd14fd26a544\n};var create=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(){var _assets,promises,date,sigMsg,hashMsg,encMsg;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(validate()){_context6.next=2;break;}return _context6.abrupt(\"return\");case 2:setLoading(true);_assets=[];promises=assets.map(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(asset){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.t0=_assets;_context5.t1=asset.token;_context5.next=4;return getAssetLongValue(Number.parseFloat(asset.value),asset.token);case 4:_context5.t2=_context5.sent;_context5.t3={token:_context5.t1,value:_context5.t2};_context5.t0.push.call(_context5.t0,_context5.t3);case 7:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x5){return _ref6.apply(this,arguments);};}());_context6.next=7;return Promise.all(promises);case 7:date=inputToDate(distributionDate);sigMsg=message===\"\"?\"\":\"PF:\".concat(message);hashMsg=sigMsg===\"\"?\"\":getMD5(sigMsg).concat(message);encMsg=aesEncrypt(hashMsg,messagePassword);_context6.next=13;return createCapsule(beneficiary,date,getPeriodSize(distributionFrequency),periodType===\"immediate\"?1:Number(distributionPeriods),_assets,addingAssetsAllowed===\"yes\",encMsg);case 13:console.log(\"create:\",encMsg);gtag(\"event\",\"created\");gtag(\"event\",\"conversion\");setComplete(true);case 17:case\"end\":return _context6.stop();}}},_callee6);}));return function create(){return _ref5.apply(this,arguments);};}();var isValid=function isValid(){return!addressError&&!distributionPeriodsError&&!distributionDateError&&!messageError&&!messageCopyError;};var validate=function validate(){var dateValid=validateDate(distributionDate);var addressValid=validateAddress(beneficiary);var messageValid=validateMessage(message);var messagePasswordValid=validatePassword(messagePassword);var periodsValid=periodType===\"immediate\"?true:validatePeriods(distributionPeriods);return dateValid&&addressValid&&messageValid&&messagePasswordValid&&periodsValid;};var validateDate=function validateDate(value){try{var lDt=value.split(\" \");var value_d=lDt[0];var items=value_d.split(\"/\");var time=lDt.length>1?lDt[1].split(\":\"):[\"00\",\"00\",\"00\"];var newDate=new Date(\"\".concat(items[0],\"/\").concat(items[1],\"/\").concat(items[2],\" \").concat(time[0],\":\").concat(time[1],\":\").concat(time[2]));var now=new Date();if(items.length!==3||time.length!==3)setDistributionDateError(\"Incorrect Date format: \"+\"\".concat(items[0],\"/\").concat(items[1],\"/\").concat(items[2],\" \").concat(time[0],\":\").concat(time[1],\":\").concat(time[2]));else if(newDate<now)setDistributionDateError(\"Date must be in future: \"+\"\".concat(items[0],\"/\").concat(items[1],\"/\").concat(items[2],\" \").concat(time[0],\":\").concat(time[1],\":\").concat(time[2]));else{setDistributionDateError(\"\");return true;}}catch(_unused){setDistributionDateError(\"Incorrect Date format\");}return false;};var validateAddress=function validateAddress(value){if(value.length!==42)setAddressError(\"Invalid Address\");else{setAddressError(\"\");return true;}return false;};var validateMessage=function validateMessage(value){var encValue=escape(value);if(encValue.length>100)setMessageError(\"Too Long\");else if(unescape(encValue)!==value)setMessageError(\"Cannot be Encoded by Unicode\");else{setMessageError(\"\");return true;}return false;};var validatePassword=function validatePassword(value){if(message.length>0&&value.length!==32)setMessageCopyError(\"Please Push the Copy Button Under the Message Box\");else{setMessageCopyError(\"\");return true;}return false;};var validatePeriods=function validatePeriods(value){var periods=0;try{periods=Number(value);if(periods<=0)setDistributionPeriodsError(\"Periods must be a positive number\");else if(periods===1)setDistributionPeriodsError(\"For only one period, use an Immediate Capsule\");else{setDistributionPeriodsError(\"\");return true;}}catch(_unused2){setDistributionPeriodsError(\"Invalid Number\");}return false;};var randomString=function randomString(len){var chars=\"ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678\";var maxPos=chars.length;var pwd=\"\";for(var i=0;i<len;i++){pwd+=chars.charAt(Math.floor(Math.random()*maxPos));}return pwd;};var copyMessagePassword=function copyMessagePassword(){var currMessagePassword=randomString(32);setMessagePassword(currMessagePassword);if(copy(currMessagePassword)){console.log(\"Password Copied\");setMessagePasswordCopyState(true);validatePassword(currMessagePassword);return true;}setMessagePasswordCopyState(false);return false;};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Popup,{show:!complete,close:props.close,header:\"Create Vault\",content:/*#__PURE__*/_jsxs(Content,{children:[/*#__PURE__*/_jsx(Selector,{options:[\"immediate\",\"staggered\"],activeOption:periodType,setOption:function setOption(option){setPeriodType(option);setDistributionPeriodsError(\"\");},label:\"Distribution Type\",tooltip:\"An Immediate Capsule will open completely on the distribution date, allowing all crypto to be accessed at once. A Staggered Capsule will first open on the Distribution Start Date for a portion of the crypto, and more crypto will become accessible at the defined intervals\"}),/*#__PURE__*/_jsx(TextInput,{label:periodType===\"immediate\"?\"Distribution Date\":\"Distribution Start Date\",placeholder:\"yyyy/mm/dd HH:MM:SS\",tooltip:periodType===\"immediate\"?\"This is the date when the capsule will be able to be opened\":\"This is the date when the capsule will first be able to be opened\",value:distributionDate,setValue:function setValue(value){validateDate(value);setDistributionDate(value);}}),distributionDateError&&/*#__PURE__*/_jsx(ValidationError,{children:distributionDateError}),periodType===\"staggered\"&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Dropdown,{label:\"Distribution Frequency\",tooltip:\"How often the crypto should be distributed to the beneficiary after the capsule is opened\",options:[\"daily\",\"weekly\",\"monthly\",\"annually\"],activeOption:distributionFrequency,setOption:function setOption(option){return setDistributionFrequency(option);}}),/*#__PURE__*/_jsx(TextInput,{label:\"Distribution Periods\",placeholder:\"e.g. 12\",tooltip:\"How many periods the crypto should be spread out over for the staggerd distribution\",value:distributionPeriods,setValue:function setValue(value){validatePeriods(value);setDistributionPeriods(value);}}),distributionPeriodsError&&/*#__PURE__*/_jsx(ValidationError,{children:distributionPeriodsError})]}),/*#__PURE__*/_jsx(TextInput,{label:\"Beneficiary\",placeholder:\"e.g. 0x07d48BDBA7975f0DAF73BD5b85A2E3Ff87ffb24e\",tooltip:\"This is the wallet address that your crypto will be sent to on the distribution date\",value:beneficiary,setValue:function setValue(value){validateAddress(value);setBeneficiary(value);}}),addressError&&/*#__PURE__*/_jsx(ValidationError,{children:addressError}),/*#__PURE__*/_jsx(TextInput,{label:\"Message\",placeholder:\"Hello!\",tooltip:\"This is the message you send to your beneficiary. It can only be seen after the Capsule is unlocked and the password below is input.\",value:message,setValue:function setValue(value){validateMessage(value);setMessage(value);}}),messageError&&/*#__PURE__*/_jsx(ValidationError,{children:messageError}),messageCopyError&&/*#__PURE__*/_jsx(ValidationError,{children:messageCopyError}),/*#__PURE__*/_jsx(ButtonContainer,{children:/*#__PURE__*/_jsx(Button,{small:true,disabled:message.length===0,text:message.length===0?\"No Message Attached\":messagePasswordCopyState?\"Message Password Copied\":\"Copy Message Password\",click:function click(){return copyMessagePassword();}})}),/*#__PURE__*/_jsx(Selector,{options:[\"yes\",\"no\"],activeOption:addingAssetsAllowed,setOption:function setOption(option){return setAddingAssetsAllowed(option);},label:\"Adding Assets Allowed\",tooltip:\"Controls if you are able to continue to add assets to the capsule after it has been created. 'Yes' will mean you can keep adding assets after it has been created. 'No' means that you can only add assets once when it is created.\"}),/*#__PURE__*/_jsx(Assets,{assets:assets,setAssets:function setAssets(assets){_setAssets(assets);updateApprovals(assets);}})]}),buttonText:unapproved.length===0?\"Create\":\"Approve \".concat(addressSymbol(unapproved[0].asset.token)),buttonAction:function buttonAction(){if(unapproved.length===0)create();else tokenApprove(unapproved[0].asset.token);},loading:loading,buttonDisabled:!isValid()}),/*#__PURE__*/_jsx(Popup,{show:complete,close:props.close,header:\"Capsule Created!\",image:lockedCapsule,body:\"Click below to view your capsule\",buttonText:\"View Capsule\",buttonAction:function buttonAction(){return history.push(\"/sent\");}})]});};export default CreateCapsule;","map":{"version":3,"sources":["/Users/richard/Documents/GitHub/time_capsule/client/src/components/CreateCapsule.tsx"],"names":["React","useState","crypto","copy","BN","useSelector","styled","useHistory","gtag","lockedCapsule","createCapsule","getAssetLongValue","getTokenContract","tokenApproved","getPeriodSize","inputToDate","selectTokens","Assets","TextInput","Popup","ValidationError","Selector","Dropdown","getGlobals","Button","Content","div","ButtonContainer","CreateCapsule","props","show","history","ethAsset","token","value","approval","asset","approved","loading","setLoading","complete","setComplete","messagePasswordCopyState","setMessagePasswordCopyState","beneficiary","setBeneficiary","message","setMessage","distributionDate","setDistributionDate","messagePassword","setMessagePassword","periodType","setPeriodType","distributionFrequency","setDistributionFrequency","distributionPeriods","setDistributionPeriods","distributionDateError","setDistributionDateError","addingAssetsAllowed","setAddingAssetsAllowed","addressError","setAddressError","messageError","setMessageError","messageCopyError","setMessageCopyError","distributionPeriodsError","setDistributionPeriodsError","assets","setAssets","approvals","setApprovals","tokens","unapproved","filter","a","addressSymbol","address","symbol","updateApprovals","_approvals","promises","map","push","Promise","all","tokenApprove","globals","tokenContract","methods","approve","CAPSULE","send","on","hash","receipt","err","console","log","aesEncrypt","key","encValue","escape","cipher","createCipheriv","slice","crypted","update","final","getMD5","createHash","digest","create","validate","_assets","Number","parseFloat","date","sigMsg","concat","hashMsg","encMsg","isValid","dateValid","validateDate","addressValid","validateAddress","messageValid","validateMessage","messagePasswordValid","validatePassword","periodsValid","validatePeriods","lDt","split","value_d","items","time","length","newDate","Date","now","unescape","periods","randomString","len","chars","maxPos","pwd","i","charAt","Math","floor","random","copyMessagePassword","currMessagePassword","close","option"],"mappings":"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","sourcesContent":["import React, { useState } from \"react\";\nimport crypto from \"crypto\";\nimport copy from \"copy-to-clipboard\";\nimport BN from \"bn.js\";\nimport { useSelector } from \"react-redux\";\nimport styled from \"styled-components\";\nimport { useHistory } from \"react-router\";\nimport { gtag } from \"@deptno/gtag\";\nimport lockedCapsule from \"../assets/capsule-locked-large.png\";\n\nimport {\n  createCapsule,\n  getAssetLongValue,\n  getTokenContract,\n  tokenApproved,\n} from \"../services/contracthelper\";\nimport { getPeriodSize, inputToDate } from \"../services/dateHelper\";\nimport { selectTokens } from \"../state/tokenSlice\";\nimport { Asset } from \"../types/CapsuleType\";\nimport Token from \"../types/Token\";\nimport Assets from \"./Assets\";\nimport TextInput from \"./TextInput\";\nimport Popup from \"./Popup\";\nimport { ValidationError } from \"../styles/ValidationError\";\nimport Selector from \"./Selector\";\nimport Dropdown from \"./Dropdown\";\nimport { getGlobals } from \"../utils/globals\";\nimport Button from \"./Button\";\n\ntype Approval = {\n  asset: Asset;\n  approved: boolean;\n};\n\nconst Content = styled.div`\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n`;\n\nconst ButtonContainer = styled.div`\n  margin-top: 2rem;\n  display: flex;\n\n  button {\n    margin: 0 1rem;\n  }\n\n  @media (max-width: 768px) {\n    flex-direction: column;\n\n    button {\n      margin: 1rem 0;\n    }\n  }\n`;\n\ntype Props = {\n  show: boolean;\n  close: () => void;\n};\n\nconst CreateCapsule = (props: Props): JSX.Element => {\n  if (!props.show) return <></>;\n\n  const history = useHistory();\n\n  const ethAsset: Asset = { token: \"ETH\", value: \"0\" };\n  const approval: Approval = { asset: ethAsset, approved: true };\n\n  const [loading, setLoading] = useState(false);\n  const [complete, setComplete] = useState(false);\n  const [messagePasswordCopyState, setMessagePasswordCopyState] = useState(\n    false\n  );\n  const [beneficiary, setBeneficiary] = useState(\"\");\n  const [message, setMessage] = useState(\"\");\n  const [distributionDate, setDistributionDate] = useState(\"\");\n  const [messagePassword, setMessagePassword] = useState(\"\");\n  const [periodType, setPeriodType] = useState(\"immediate\");\n  const [distributionFrequency, setDistributionFrequency] = useState(\"monthly\");\n  const [distributionPeriods, setDistributionPeriods] = useState(\"\");\n  const [distributionDateError, setDistributionDateError] = useState(\"\");\n  const [addingAssetsAllowed, setAddingAssetsAllowed] = useState(\"yes\");\n  const [addressError, setAddressError] = useState(\"\");\n  const [messageError, setMessageError] = useState(\"\");\n  const [messageCopyError, setMessageCopyError] = useState(\"\");\n  const [distributionPeriodsError, setDistributionPeriodsError] = useState(\"\");\n  const [assets, setAssets] = useState<Asset[]>([ethAsset]);\n  const [approvals, setApprovals] = useState<Approval[]>([approval]);\n\n  const tokens = useSelector(selectTokens);\n\n  const unapproved = approvals.filter((a: Approval) => !a.approved);\n\n  const addressSymbol = (address: string) =>\n    tokens.filter((token: Token) => token.address === address)[0].symbol;\n\n  const updateApprovals = async (assets: Asset[]) => {\n    const _approvals: Approval[] = [];\n    const promises = assets.map(async (asset: Asset) => {\n      _approvals.push({\n        asset,\n        approved: await tokenApproved(asset.token),\n      });\n    });\n    await Promise.all(promises);\n    setApprovals(_approvals);\n  };\n\n  const tokenApprove = async (address: string) => {\n    const globals = await getGlobals();\n    const tokenContract = await getTokenContract(address);\n    tokenContract.methods\n      .approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\"))\n      .send()\n      .on(\"transactionHash\", (hash: any) => {\n        setLoading(true);\n      })\n      .on(\"receipt\", async (receipt: any) => {\n        await updateApprovals(assets);\n        setLoading(false);\n      })\n      .on(\"error\", (err: any) => {\n        console.log(`Error: ${err}`);\n        setLoading(false);\n      });\n  };\n\n  const aesEncrypt = (value: string, key: string): string => {\n    if (value === \"\") return \"\";\n    const encValue = escape(value);\n    const cipher = crypto.createCipheriv(\n      \"aes-128-cbc\",\n      key.slice(0, 16),\n      key.slice(16)\n    );\n    let crypted = cipher.update(encValue, \"utf8\", \"hex\");\n    crypted += cipher.final(\"hex\");\n    return crypted;\n  };\n\n  const getMD5 = (value: string): string => {\n    const hash = crypto.createHash(\"md5\");\n    hash.update(value);\n    return hash.digest(\"hex\"); // 7e1977739c748beac0c0fd14fd26a544\n  };\n\n  const create = async () => {\n    if (!validate()) return;\n\n    setLoading(true);\n\n    const _assets: Asset[] = [];\n\n    const promises: Promise<void>[] = assets.map(async (asset: Asset) => {\n      _assets.push({\n        token: asset.token,\n        value: await getAssetLongValue(\n          Number.parseFloat(asset.value),\n          asset.token\n        ),\n      });\n    });\n\n    await Promise.all(promises);\n\n    const date = inputToDate(distributionDate);\n    const sigMsg = message === \"\" ? \"\" : \"PF:\".concat(message);\n    const hashMsg = sigMsg === \"\" ? \"\" : getMD5(sigMsg).concat(message);\n    const encMsg = aesEncrypt(hashMsg, messagePassword);\n\n    await createCapsule(\n      beneficiary,\n      date,\n      getPeriodSize(distributionFrequency),\n      periodType === \"immediate\" ? 1 : Number(distributionPeriods),\n      _assets,\n      addingAssetsAllowed === \"yes\",\n      encMsg\n    );\n\n    console.log(\"create:\", encMsg);\n\n    gtag(\"event\", \"created\");\n    gtag(\"event\", \"conversion\");\n    setComplete(true);\n  };\n\n  const isValid = (): boolean =>\n    !addressError &&\n    !distributionPeriodsError &&\n    !distributionDateError &&\n    !messageError &&\n    !messageCopyError;\n\n  const validate = (): boolean => {\n    const dateValid = validateDate(distributionDate);\n    const addressValid = validateAddress(beneficiary);\n    const messageValid = validateMessage(message);\n    const messagePasswordValid = validatePassword(messagePassword);\n    const periodsValid =\n      periodType === \"immediate\" ? true : validatePeriods(distributionPeriods);\n    return (\n      dateValid &&\n      addressValid &&\n      messageValid &&\n      messagePasswordValid &&\n      periodsValid\n    );\n  };\n\n  const validateDate = (value: string): boolean => {\n    try {\n      const lDt = value.split(\" \");\n      const value_d = lDt[0];\n      const items = value_d.split(\"/\");\n      const time = lDt.length > 1 ? lDt[1].split(\":\") : [\"00\", \"00\", \"00\"];\n      const newDate = new Date(\n        `${items[0]}/${items[1]}/${items[2]} ${time[0]}:${time[1]}:${time[2]}`\n      );\n      const now = new Date();\n      if (items.length !== 3 || time.length !== 3)\n        setDistributionDateError(\n          \"Incorrect Date format: \" +\n            `${items[0]}/${items[1]}/${items[2]} ${time[0]}:${time[1]}:${time[2]}`\n        );\n      else if (newDate < now)\n        setDistributionDateError(\n          \"Date must be in future: \" +\n            `${items[0]}/${items[1]}/${items[2]} ${time[0]}:${time[1]}:${time[2]}`\n        );\n      else {\n        setDistributionDateError(\"\");\n        return true;\n      }\n    } catch {\n      setDistributionDateError(\"Incorrect Date format\");\n    }\n    return false;\n  };\n\n  const validateAddress = (value: string): boolean => {\n    if (value.length !== 42) setAddressError(\"Invalid Address\");\n    else {\n      setAddressError(\"\");\n      return true;\n    }\n    return false;\n  };\n\n  const validateMessage = (value: string): boolean => {\n    const encValue = escape(value);\n    if (encValue.length > 100) setMessageError(\"Too Long\");\n    else if (unescape(encValue) !== value)\n      setMessageError(\"Cannot be Encoded by Unicode\");\n    else {\n      setMessageError(\"\");\n      return true;\n    }\n    return false;\n  };\n\n  const validatePassword = (value: string): boolean => {\n    if (message.length > 0 && value.length !== 32)\n      setMessageCopyError(\"Please Push the Copy Button Under the Message Box\");\n    else {\n      setMessageCopyError(\"\");\n      return true;\n    }\n    return false;\n  };\n\n  const validatePeriods = (value: string): boolean => {\n    let periods = 0;\n    try {\n      periods = Number(value);\n      if (periods <= 0)\n        setDistributionPeriodsError(\"Periods must be a positive number\");\n      else if (periods === 1)\n        setDistributionPeriodsError(\n          \"For only one period, use an Immediate Capsule\"\n        );\n      else {\n        setDistributionPeriodsError(\"\");\n        return true;\n      }\n    } catch {\n      setDistributionPeriodsError(\"Invalid Number\");\n    }\n    return false;\n  };\n\n  const randomString = (len: number): string => {\n    const chars = \"ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678\";\n    const maxPos = chars.length;\n    let pwd = \"\";\n    for (let i = 0; i < len; i++) {\n      pwd += chars.charAt(Math.floor(Math.random() * maxPos));\n    }\n    return pwd;\n  };\n\n  const copyMessagePassword = (): boolean => {\n    const currMessagePassword = randomString(32);\n    setMessagePassword(currMessagePassword);\n    if (copy(currMessagePassword)) {\n      console.log(\"Password Copied\");\n      setMessagePasswordCopyState(true);\n      validatePassword(currMessagePassword);\n      return true;\n    }\n    setMessagePasswordCopyState(false);\n    return false;\n  };\n\n  return (\n    <>\n      <Popup\n        show={!complete}\n        close={props.close}\n        header=\"Create Vault\"\n        content={\n          <Content>\n            <Selector\n              options={[\"immediate\", \"staggered\"]}\n              activeOption={periodType}\n              setOption={(option: string) => {\n                setPeriodType(option);\n                setDistributionPeriodsError(\"\");\n              }}\n              label=\"Distribution Type\"\n              tooltip=\"An Immediate Capsule will open completely on the distribution date, allowing all crypto to be accessed at once. A Staggered Capsule will first open on the Distribution Start Date for a portion of the crypto, and more crypto will become accessible at the defined intervals\"\n            />\n            <TextInput\n              label={\n                periodType === \"immediate\"\n                  ? \"Distribution Date\"\n                  : \"Distribution Start Date\"\n              }\n              placeholder=\"yyyy/mm/dd HH:MM:SS\"\n              tooltip={\n                periodType === \"immediate\"\n                  ? \"This is the date when the capsule will be able to be opened\"\n                  : \"This is the date when the capsule will first be able to be opened\"\n              }\n              value={distributionDate}\n              setValue={(value: string) => {\n                validateDate(value);\n                setDistributionDate(value);\n              }}\n            />\n            {distributionDateError && (\n              <ValidationError>{distributionDateError}</ValidationError>\n            )}\n            {periodType === \"staggered\" && (\n              <>\n                <Dropdown\n                  label=\"Distribution Frequency\"\n                  tooltip=\"How often the crypto should be distributed to the beneficiary after the capsule is opened\"\n                  options={[\"daily\", \"weekly\", \"monthly\", \"annually\"]}\n                  activeOption={distributionFrequency}\n                  setOption={(option: string) =>\n                    setDistributionFrequency(option)\n                  }\n                />\n                <TextInput\n                  label=\"Distribution Periods\"\n                  placeholder=\"e.g. 12\"\n                  tooltip=\"How many periods the crypto should be spread out over for the staggerd distribution\"\n                  value={distributionPeriods}\n                  setValue={(value: string) => {\n                    validatePeriods(value);\n                    setDistributionPeriods(value);\n                  }}\n                />\n                {distributionPeriodsError && (\n                  <ValidationError>{distributionPeriodsError}</ValidationError>\n                )}\n              </>\n            )}\n            <TextInput\n              label=\"Beneficiary\"\n              placeholder=\"e.g. 0x07d48BDBA7975f0DAF73BD5b85A2E3Ff87ffb24e\"\n              tooltip=\"This is the wallet address that your crypto will be sent to on the distribution date\"\n              value={beneficiary}\n              setValue={(value: string) => {\n                validateAddress(value);\n                setBeneficiary(value);\n              }}\n            />\n            {addressError && <ValidationError>{addressError}</ValidationError>}\n            <TextInput\n              label=\"Message\"\n              placeholder=\"Hello!\"\n              tooltip=\"This is the message you send to your beneficiary. It can only be seen after the Capsule is unlocked and the password below is input.\"\n              value={message}\n              setValue={(value: string) => {\n                validateMessage(value);\n                setMessage(value);\n              }}\n            />\n            {messageError && <ValidationError>{messageError}</ValidationError>}\n            {messageCopyError && (\n              <ValidationError>{messageCopyError}</ValidationError>\n            )}\n            <ButtonContainer>\n              <Button\n                small\n                disabled={message.length === 0}\n                text={\n                  message.length === 0\n                    ? \"No Message Attached\"\n                    : messagePasswordCopyState\n                    ? \"Message Password Copied\"\n                    : \"Copy Message Password\"\n                }\n                click={() => copyMessagePassword()}\n              />\n            </ButtonContainer>\n            <Selector\n              options={[\"yes\", \"no\"]}\n              activeOption={addingAssetsAllowed}\n              setOption={(option: string) => setAddingAssetsAllowed(option)}\n              label=\"Adding Assets Allowed\"\n              tooltip=\"Controls if you are able to continue to add assets to the capsule after it has been created. 'Yes' will mean you can keep adding assets after it has been created. 'No' means that you can only add assets once when it is created.\"\n            />\n            <Assets\n              assets={assets}\n              setAssets={(assets: Asset[]) => {\n                setAssets(assets);\n                updateApprovals(assets);\n              }}\n            />\n          </Content>\n        }\n        buttonText={\n          unapproved.length === 0\n            ? \"Create\"\n            : `Approve ${addressSymbol(unapproved[0].asset.token)}`\n        }\n        buttonAction={() => {\n          if (unapproved.length === 0) create();\n          else tokenApprove(unapproved[0].asset.token);\n        }}\n        loading={loading}\n        buttonDisabled={!isValid()}\n      />\n      <Popup\n        show={complete}\n        close={props.close}\n        header=\"Capsule Created!\"\n        image={lockedCapsule}\n        body=\"Click below to view your capsule\"\n        buttonText=\"View Capsule\"\n        buttonAction={() => history.push(\"/sent\")}\n      />\n    </>\n  );\n};\n\nexport default CreateCapsule;\n"]},"metadata":{},"sourceType":"module"}