{"ast":null,"code":"import _regeneratorRuntime from\"/Users/richard/Downloads/crypto-capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/richard/Downloads/crypto-capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import Web3 from\"web3\";import BN from\"bn.js\";import capsuleAbi from\"../contracts/CryptoCapsule.json\";import tokenAbi from\"../contracts/ERC20.json\";import{toEthUnit}from\"./web3Service\";import{dateToUnix,getPeriodType,UnixToDate}from\"./dateHelper\";import{getGlobals}from\"../utils/globals\";// Shared\nexport var isConnected=function isConnected(){return window.web3.eth;};export var getAddress=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var addressList;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!window.ethereum){_context.next=7;break;}window.web3=new Web3(window.ethereum);window.ethereum.enable();_context.next=5;return window.web3.eth.getAccounts();case 5:addressList=_context.sent;return _context.abrupt(\"return\",addressList[0]);case 7:return _context.abrupt(\"return\",\"\");case 8:case\"end\":return _context.stop();}}},_callee);}));return function getAddress(){return _ref.apply(this,arguments);};}();export var getCapsuleContract=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var globals;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getGlobals();case 2:globals=_context2.sent;_context2.t0=window.web3.eth.Contract;_context2.t1=capsuleAbi;_context2.t2=globals.CAPSULE;_context2.next=8;return getAddress();case 8:_context2.t3=_context2.sent;_context2.t4={from:_context2.t3};return _context2.abrupt(\"return\",new _context2.t0(_context2.t1,_context2.t2,_context2.t4));case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function getCapsuleContract(){return _ref2.apply(this,arguments);};}();export var getTokenContract=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(token){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.t0=window.web3.eth.Contract;_context3.t1=tokenAbi;_context3.t2=token;_context3.next=5;return getAddress();case 5:_context3.t3=_context3.sent;_context3.t4={from:_context3.t3};return _context3.abrupt(\"return\",new _context3.t0(_context3.t1,_context3.t2,_context3.t4));case 8:case\"end\":return _context3.stop();}}},_callee3);}));return function getTokenContract(_x){return _ref3.apply(this,arguments);};}();// Functions\nexport var createCapsule=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(beneficiary,distributionDate,periodSize,periodCount,assets,addingAssetsAllowed){var address,capsuleContract,ethAssets,eth,otherAssets,tx;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return getAddress();case 2:address=_context4.sent;_context4.next=5;return getCapsuleContract();case 5:capsuleContract=_context4.sent;ethAssets=assets.filter(function(a){return a.token===\"ETH\";});eth=ethAssets.length===1?ethAssets[0].value:0;otherAssets=assets.filter(function(a){return a.token!==\"ETH\";});tx={from:address,value:eth};_context4.next=12;return capsuleContract.methods.createCapsule(beneficiary,dateToUnix(distributionDate),periodSize,periodCount,otherAssets.map(function(a){return a.token;}),otherAssets.map(function(a){return a.value;}),addingAssetsAllowed).send(tx);case 12:case\"end\":return _context4.stop();}}},_callee4);}));return function createCapsule(_x2,_x3,_x4,_x5,_x6,_x7){return _ref4.apply(this,arguments);};}();export var openCapsule=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(capsuleId){var capsuleContract;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return getCapsuleContract();case 2:capsuleContract=_context5.sent;_context5.next=5;return capsuleContract.methods.openCapsule(new BN(capsuleId)).send();case 5:case\"end\":return _context5.stop();}}},_callee5);}));return function openCapsule(_x8){return _ref5.apply(this,arguments);};}();export var addAssets=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(capsuleId,assets){var address,capsuleContract,ethAssets,eth,otherAssets,tx;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return getAddress();case 2:address=_context6.sent;_context6.next=5;return getCapsuleContract();case 5:capsuleContract=_context6.sent;ethAssets=assets.filter(function(a){return a.token===\"ETH\";});eth=ethAssets.length===1?ethAssets[0].value:0;otherAssets=assets.filter(function(a){return a.token!==\"ETH\";});tx={from:address,value:eth};_context6.next=12;return capsuleContract.methods.addAssets(capsuleId,otherAssets.map(function(a){return a.token;}),otherAssets.map(function(a){return a.value;})).send(tx);case 12:case\"end\":return _context6.stop();}}},_callee6);}));return function addAssets(_x9,_x10){return _ref6.apply(this,arguments);};}();export var updateBeneficiary=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(capsuleId,beneficiary){var capsuleContract;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return getCapsuleContract();case 2:capsuleContract=_context7.sent;_context7.next=5;return capsuleContract.methods.updateBeneficiary(capsuleId,beneficiary).send();case 5:case\"end\":return _context7.stop();}}},_callee7);}));return function updateBeneficiary(_x11,_x12){return _ref7.apply(this,arguments);};}();// Views\nexport var getCapsule=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(capsuleId){var capsuleContract,response;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(isConnected()){_context8.next=2;break;}return _context8.abrupt(\"return\",null);case 2:_context8.next=4;return getCapsuleContract();case 4:capsuleContract=_context8.sent;_context8.next=7;return capsuleContract.methods.getCapsule(capsuleId).call();case 7:response=_context8.sent;return _context8.abrupt(\"return\",responseToCapsule(response));case 9:case\"end\":return _context8.stop();}}},_callee8);}));return function getCapsule(_x13){return _ref8.apply(this,arguments);};}();export var getSentCapsules=/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(){var address,capsuleContract,response;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:if(isConnected()){_context9.next=2;break;}return _context9.abrupt(\"return\",[]);case 2:_context9.next=4;return getAddress();case 4:address=_context9.sent;_context9.next=7;return getCapsuleContract();case 7:capsuleContract=_context9.sent;_context9.next=10;return capsuleContract.methods.getSentCapsules(address).call();case 10:response=_context9.sent;return _context9.abrupt(\"return\",response.map(function(rc){return responseToCapsule(rc);}));case 12:case\"end\":return _context9.stop();}}},_callee9);}));return function getSentCapsules(){return _ref9.apply(this,arguments);};}();export var getReceivedCapsules=/*#__PURE__*/function(){var _ref10=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(){var address,capsuleContract,response;return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:if(isConnected()){_context10.next=2;break;}return _context10.abrupt(\"return\",[]);case 2:_context10.next=4;return getAddress();case 4:address=_context10.sent;_context10.next=7;return getCapsuleContract();case 7:capsuleContract=_context10.sent;_context10.next=10;return capsuleContract.methods.getReceivedCapsules(address).call();case 10:response=_context10.sent;return _context10.abrupt(\"return\",response.map(function(rc){return responseToCapsule(rc);}));case 12:case\"end\":return _context10.stop();}}},_callee10);}));return function getReceivedCapsules(){return _ref10.apply(this,arguments);};}();// Utils\nexport var responseToCapsule=function responseToCapsule(capsule){var assets=[];var eth=toEthUnit(new BN(capsule.value));if(eth>0)assets.push({token:\"ETH\",value:capsule.value});for(var i=0;i<capsule.tokens.length;i++){assets.push({token:capsule.tokens[i],value:capsule.amounts[i]});}return{id:Number(capsule.id),beneficiary:capsule.beneficiary,grantor:capsule.grantor,empty:capsule.empty,createdDate:UnixToDate(Number.parseFloat(capsule.createdDate)),distributionDate:UnixToDate(Number.parseFloat(capsule.distributionDate)),periodType:getPeriodType(capsule.periodSize),periodCount:Number(capsule.periodCount),claimedPeriods:Number(capsule.claimedPeriods),assets:assets,addingAssetsAllowed:capsule.addingAssetsAllowed};};export var ethBalance=/*#__PURE__*/function(){var _ref11=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee11(){var address,wei;return _regeneratorRuntime.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.next=2;return getAddress();case 2:address=_context11.sent;_context11.next=5;return window.web3.eth.getBalance(address);case 5:wei=_context11.sent;return _context11.abrupt(\"return\",toEthUnit(wei));case 7:case\"end\":return _context11.stop();}}},_callee11);}));return function ethBalance(){return _ref11.apply(this,arguments);};}();// Tokens\nexport var approveToken=/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee12(token){var globals,tokenContract;return _regeneratorRuntime.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.next=2;return getGlobals();case 2:globals=_context12.sent;_context12.next=5;return getTokenContract(token);case 5:tokenContract=_context12.sent;_context12.next=8;return tokenContract.methods.approve(globals.CAPSULE,new BN(\"9999999999999999999999999999\")).send();case 8:case\"end\":return _context12.stop();}}},_callee12);}));return function approveToken(_x14){return _ref12.apply(this,arguments);};}();export var tokenApproved=/*#__PURE__*/function(){var _ref13=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee13(token){var globals,address,tokenContract,allowance;return _regeneratorRuntime.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:if(!(token===\"ETH\")){_context13.next=2;break;}return _context13.abrupt(\"return\",true);case 2:_context13.next=4;return getGlobals();case 4:globals=_context13.sent;_context13.next=7;return getAddress();case 7:address=_context13.sent;_context13.next=10;return getTokenContract(token);case 10:tokenContract=_context13.sent;_context13.next=13;return tokenContract.methods.allowance(address,globals.CAPSULE).call();case 13:allowance=_context13.sent;return _context13.abrupt(\"return\",new BN(allowance).gt(new BN(\"9999999999999999999999\")));case 15:case\"end\":return _context13.stop();}}},_callee13);}));return function tokenApproved(_x15){return _ref13.apply(this,arguments);};}();export var tokenBalance=/*#__PURE__*/function(){var _ref14=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee14(token){var address,tokenContract,cents;return _regeneratorRuntime.wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:_context14.next=2;return getAddress();case 2:address=_context14.sent;_context14.next=5;return getTokenContract(token.address);case 5:tokenContract=_context14.sent;_context14.next=8;return tokenContract.methods.balanceOf(address).call();case 8:cents=_context14.sent;return _context14.abrupt(\"return\",cents/Math.pow(10,token.decimals));case 10:case\"end\":return _context14.stop();}}},_callee14);}));return function tokenBalance(_x16){return _ref14.apply(this,arguments);};}();export var getAssetSymbol=/*#__PURE__*/function(){var _ref15=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee15(token){var tokenContract;return _regeneratorRuntime.wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:if(!(token.toLocaleLowerCase()===\"eth\")){_context15.next=2;break;}return _context15.abrupt(\"return\",\"ETH\");case 2:_context15.next=4;return getTokenContract(token);case 4:tokenContract=_context15.sent;return _context15.abrupt(\"return\",tokenContract.methods.symbol().call());case 6:case\"end\":return _context15.stop();}}},_callee15);}));return function getAssetSymbol(_x17){return _ref15.apply(this,arguments);};}();export var getAssetDecimals=/*#__PURE__*/function(){var _ref16=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee16(token){var tokenContract;return _regeneratorRuntime.wrap(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:if(!(token.toLocaleLowerCase()===\"eth\")){_context16.next=2;break;}return _context16.abrupt(\"return\",18);case 2:_context16.next=4;return getTokenContract(token);case 4:tokenContract=_context16.sent;return _context16.abrupt(\"return\",tokenContract.methods.decimals().call());case 6:case\"end\":return _context16.stop();}}},_callee16);}));return function getAssetDecimals(_x18){return _ref16.apply(this,arguments);};}();export var getAssetRealValue=/*#__PURE__*/function(){var _ref17=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee17(asset){var decimals;return _regeneratorRuntime.wrap(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:if(!(asset.value===\"0\")){_context17.next=2;break;}return _context17.abrupt(\"return\",0);case 2:_context17.next=4;return getAssetDecimals(asset.token);case 4:decimals=_context17.sent;return _context17.abrupt(\"return\",Number(asset.value)/Math.pow(10,decimals));case 6:case\"end\":return _context17.stop();}}},_callee17);}));return function getAssetRealValue(_x19){return _ref17.apply(this,arguments);};}();export var getAssetLongValue=/*#__PURE__*/function(){var _ref18=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee18(value,token){var decimals;return _regeneratorRuntime.wrap(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:if(!(value===0)){_context18.next=2;break;}return _context18.abrupt(\"return\",\"0\");case 2:_context18.next=4;return getAssetDecimals(token);case 4:decimals=_context18.sent;return _context18.abrupt(\"return\",Math.round(value*Math.pow(10,decimals)).toString());case 6:case\"end\":return _context18.stop();}}},_callee18);}));return function getAssetLongValue(_x20,_x21){return _ref18.apply(this,arguments);};}();","map":{"version":3,"sources":["/Users/richard/Downloads/crypto-capsule/client/src/services/contracthelper.ts"],"names":["Web3","BN","capsuleAbi","tokenAbi","toEthUnit","dateToUnix","getPeriodType","UnixToDate","getGlobals","isConnected","window","web3","eth","getAddress","ethereum","enable","getAccounts","addressList","getCapsuleContract","globals","Contract","CAPSULE","from","getTokenContract","token","createCapsule","beneficiary","distributionDate","periodSize","periodCount","assets","addingAssetsAllowed","address","capsuleContract","ethAssets","filter","a","length","value","otherAssets","tx","methods","map","send","openCapsule","capsuleId","addAssets","updateBeneficiary","getCapsule","call","response","responseToCapsule","getSentCapsules","rc","getReceivedCapsules","capsule","push","i","tokens","amounts","id","Number","grantor","empty","createdDate","parseFloat","periodType","claimedPeriods","ethBalance","getBalance","wei","approveToken","tokenContract","approve","tokenApproved","allowance","gt","tokenBalance","balanceOf","cents","decimals","getAssetSymbol","toLocaleLowerCase","symbol","getAssetDecimals","getAssetRealValue","asset","getAssetLongValue","Math","round","toString"],"mappings":"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","sourcesContent":["import { Contract } from \"web3-eth-contract\";\nimport Web3 from \"web3\";\nimport BN from \"bn.js\";\nimport capsuleAbi from \"../contracts/CryptoCapsule.json\";\nimport tokenAbi from \"../contracts/ERC20.json\";\nimport { toEthUnit } from \"./web3Service\";\nimport { dateToUnix, getPeriodType, UnixToDate } from \"./dateHelper\";\nimport CapsuleType, { Asset } from \"../types/CapsuleType\";\nimport ContractCapsuleType from \"../types/ContractCapsuleType\";\nimport Token from \"../types/Token\";\nimport { getGlobals } from \"../utils/globals\";\n\n// Shared\nexport const isConnected = (): boolean => {\n  return (window as any).web3.eth;\n};\n\nexport const getAddress = async (): Promise<string> => {\n  if ((window as any).ethereum) {\n    (window as any).web3 = new Web3((window as any).ethereum);\n    (window as any).ethereum.enable();\n    const addressList = await (window as any).web3.eth.getAccounts();\n    return addressList[0];\n  }\n  return \"\";\n};\n\nexport const getCapsuleContract = async (): Promise<Contract> => {\n  const globals = await getGlobals();\n  return new (window as any).web3.eth.Contract(capsuleAbi, globals.CAPSULE, {\n    from: await getAddress(),\n  });\n};\n\nexport const getTokenContract = async (token: string): Promise<Contract> => {\n  return new (window as any).web3.eth.Contract(tokenAbi, token, {\n    from: await getAddress(),\n  });\n};\n\n// Functions\nexport const createCapsule = async (\n  beneficiary: string,\n  distributionDate: Date,\n  periodSize: number,\n  periodCount: number,\n  assets: Asset[],\n  addingAssetsAllowed: boolean\n): Promise<void> => {\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n\n  const ethAssets = assets.filter((a: Asset) => a.token === \"ETH\");\n  const eth = ethAssets.length === 1 ? ethAssets[0].value : 0;\n  const otherAssets = assets.filter((a: Asset) => a.token !== \"ETH\");\n\n  const tx = {\n    from: address,\n    value: eth,\n  };\n  await capsuleContract.methods\n    .createCapsule(\n      beneficiary,\n      dateToUnix(distributionDate),\n      periodSize,\n      periodCount,\n      otherAssets.map((a: Asset) => a.token),\n      otherAssets.map((a: Asset) => a.value),\n      addingAssetsAllowed\n    )\n    .send(tx);\n};\n\nexport const openCapsule = async (capsuleId: number): Promise<void> => {\n  const capsuleContract = await getCapsuleContract();\n  await capsuleContract.methods.openCapsule(new BN(capsuleId)).send();\n};\n\nexport const addAssets = async (\n  capsuleId: number,\n  assets: Asset[]\n): Promise<void> => {\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n\n  const ethAssets = assets.filter((a: Asset) => a.token === \"ETH\");\n  const eth = ethAssets.length === 1 ? ethAssets[0].value : 0;\n  const otherAssets = assets.filter((a: Asset) => a.token !== \"ETH\");\n\n  const tx = {\n    from: address,\n    value: eth,\n  };\n  await capsuleContract.methods\n    .addAssets(\n      capsuleId,\n      otherAssets.map((a: Asset) => a.token),\n      otherAssets.map((a: Asset) => a.value)\n    )\n    .send(tx);\n};\n\nexport const updateBeneficiary = async (\n  capsuleId: number,\n  beneficiary: string\n): Promise<void> => {\n  const capsuleContract = await getCapsuleContract();\n  await capsuleContract.methods\n    .updateBeneficiary(capsuleId, beneficiary)\n    .send();\n};\n\n// Views\nexport const getCapsule = async (\n  capsuleId: number\n): Promise<CapsuleType | null> => {\n  if (!isConnected()) return null;\n  const capsuleContract = await getCapsuleContract();\n  const response: ContractCapsuleType = await capsuleContract.methods\n    .getCapsule(capsuleId)\n    .call();\n  return responseToCapsule(response);\n};\n\nexport const getSentCapsules = async (): Promise<CapsuleType[]> => {\n  if (!isConnected()) return [];\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const response: ContractCapsuleType[] = await capsuleContract.methods\n    .getSentCapsules(address)\n    .call();\n  return response.map((rc: ContractCapsuleType) => responseToCapsule(rc));\n};\n\nexport const getReceivedCapsules = async (): Promise<CapsuleType[]> => {\n  if (!isConnected()) return [];\n  const address = await getAddress();\n  const capsuleContract = await getCapsuleContract();\n  const response: ContractCapsuleType[] = await capsuleContract.methods\n    .getReceivedCapsules(address)\n    .call();\n  return response.map((rc: ContractCapsuleType) => responseToCapsule(rc));\n};\n\n// Utils\nexport const responseToCapsule = (\n  capsule: ContractCapsuleType\n): CapsuleType => {\n  const assets: Asset[] = [];\n  const eth = toEthUnit(new BN(capsule.value));\n  if (eth > 0) assets.push({ token: \"ETH\", value: capsule.value });\n  for (let i = 0; i < capsule.tokens.length; i++) {\n    assets.push({\n      token: capsule.tokens[i],\n      value: capsule.amounts[i],\n    });\n  }\n\n  return {\n    id: Number(capsule.id),\n    beneficiary: capsule.beneficiary,\n    grantor: capsule.grantor,\n    empty: capsule.empty,\n    createdDate: UnixToDate(Number.parseFloat(capsule.createdDate)),\n    distributionDate: UnixToDate(Number.parseFloat(capsule.distributionDate)),\n    periodType: getPeriodType(capsule.periodSize),\n    periodCount: Number(capsule.periodCount),\n    claimedPeriods: Number(capsule.claimedPeriods),\n    assets,\n    addingAssetsAllowed: capsule.addingAssetsAllowed,\n  };\n};\n\nexport const ethBalance = async (): Promise<number> => {\n  const address = await getAddress();\n  const wei = await window.web3.eth.getBalance(address);\n  return toEthUnit(wei);\n};\n\n// Tokens\nexport const approveToken = async (token: string): Promise<void> => {\n  const globals = await getGlobals();\n  const tokenContract = await getTokenContract(token);\n  await tokenContract.methods\n    .approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\"))\n    .send();\n};\n\nexport const tokenApproved = async (token: string): Promise<boolean> => {\n  if (token === \"ETH\") return true;\n  const globals = await getGlobals();\n  const address = await getAddress();\n  const tokenContract = await getTokenContract(token);\n  const allowance = await tokenContract.methods\n    .allowance(address, globals.CAPSULE)\n    .call();\n  return new BN(allowance).gt(new BN(\"9999999999999999999999\"));\n};\n\nexport const tokenBalance = async (token: Token): Promise<number> => {\n  const address = await getAddress();\n  const tokenContract = await getTokenContract(token.address);\n  const cents = await tokenContract.methods.balanceOf(address).call();\n  return cents / 10 ** token.decimals;\n};\n\nexport const getAssetSymbol = async (token: string): Promise<string> => {\n  if (token.toLocaleLowerCase() === \"eth\") return \"ETH\";\n  const tokenContract = await getTokenContract(token);\n  return tokenContract.methods.symbol().call();\n};\n\nexport const getAssetDecimals = async (token: string): Promise<number> => {\n  if (token.toLocaleLowerCase() === \"eth\") return 18;\n  const tokenContract = await getTokenContract(token);\n  return tokenContract.methods.decimals().call();\n};\n\nexport const getAssetRealValue = async (asset: Asset): Promise<number> => {\n  if (asset.value === \"0\") return 0;\n  const decimals = await getAssetDecimals(asset.token);\n  return Number(asset.value) / 10 ** decimals;\n};\n\nexport const getAssetLongValue = async (\n  value: number,\n  token: string\n): Promise<string> => {\n  if (value === 0) return \"0\";\n  const decimals = await getAssetDecimals(token);\n  return Math.round(value * 10 ** decimals).toString();\n};\n"]},"metadata":{},"sourceType":"module"}