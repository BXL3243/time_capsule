{"ast":null,"code":"var _jsxFileName = \"/Users/richard/Documents/GitHub/time_sapsule/client/src/components/CreateCapsule.tsx\",\n    _s = $RefreshSig$();\n\nimport React, { useState } from \"react\";\nimport BN from \"bn.js\";\nimport { useSelector } from \"react-redux\";\nimport styled from \"styled-components\";\nimport { useHistory } from \"react-router\";\nimport { gtag } from \"@deptno/gtag\";\nimport lockedCapsule from \"../assets/capsule-locked-large.png\";\nimport { createCapsule, getAssetLongValue, getTokenContract, tokenApproved } from \"../services/contracthelper\";\nimport { getPeriodSize, inputToDate } from \"../services/dateHelper\";\nimport { selectTokens } from \"../state/tokenSlice\";\nimport Assets from \"./Assets\";\nimport TextInput from \"./TextInput\";\nimport Popup from \"./Popup\";\nimport { ValidationError } from \"../styles/ValidationError\";\nimport Selector from \"./Selector\";\nimport Dropdown from \"./Dropdown\";\nimport { getGlobals } from \"../utils/globals\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst Content = styled.div`\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n`;\n_c = Content;\n\nconst CreateCapsule = props => {\n  _s();\n\n  if (!props.show) return /*#__PURE__*/_jsxDEV(_Fragment, {}, void 0, false);\n  const history = useHistory();\n  const ethAsset = {\n    token: \"ETH\",\n    value: \"0\"\n  };\n  const approval = {\n    asset: ethAsset,\n    approved: true\n  };\n  const [loading, setLoading] = useState(false);\n  const [complete, setComplete] = useState(false);\n  const [beneficiary, setBeneficiary] = useState(\"\");\n  const [distributionDate, setDistributionDate] = useState(\"\");\n  const [periodType, setPeriodType] = useState(\"immediate\");\n  const [distributionFrequency, setDistributionFrequency] = useState(\"monthly\");\n  const [distributionPeriods, setDistributionPeriods] = useState(\"\");\n  const [distributionDateError, setDistributionDateError] = useState(\"\");\n  const [addingAssetsAllowed, setAddingAssetsAllowed] = useState(\"yes\");\n  const [addressError, setAddressError] = useState(\"\");\n  const [distributionPeriodsError, setDistributionPeriodsError] = useState(\"\");\n  const [assets, setAssets] = useState([ethAsset]);\n  const [approvals, setApprovals] = useState([approval]);\n  const tokens = useSelector(selectTokens);\n  const unapproved = approvals.filter(a => !a.approved);\n\n  const addressSymbol = address => tokens.filter(token => token.address === address)[0].symbol;\n\n  const updateApprovals = async assets => {\n    const _approvals = [];\n    const promises = assets.map(async asset => {\n      _approvals.push({\n        asset,\n        approved: await tokenApproved(asset.token)\n      });\n    });\n    await Promise.all(promises);\n    setApprovals(_approvals);\n  };\n\n  const tokenApprove = async address => {\n    const globals = await getGlobals();\n    const tokenContract = await getTokenContract(address);\n    tokenContract.methods.approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\")).send().on(\"transactionHash\", hash => {\n      setLoading(true);\n    }).on(\"receipt\", async receipt => {\n      await updateApprovals(assets);\n      setLoading(false);\n    }).on(\"error\", err => {\n      console.log(`Error: ${err}`);\n      setLoading(false);\n    });\n  };\n\n  const create = async () => {\n    if (!validate()) return;\n    setLoading(true);\n    const _assets = [];\n    const promises = assets.map(async asset => {\n      _assets.push({\n        token: asset.token,\n        value: await getAssetLongValue(Number.parseFloat(asset.value), asset.token)\n      });\n    });\n    await Promise.all(promises);\n    const date = inputToDate(distributionDate);\n    await createCapsule(beneficiary, date, getPeriodSize(distributionFrequency), periodType === \"immediate\" ? 1 : Number(distributionPeriods), _assets, addingAssetsAllowed === \"yes\");\n    gtag(\"event\", \"created\");\n    gtag(\"event\", \"conversion\");\n    setComplete(true);\n  };\n\n  const isValid = () => !addressError && !distributionPeriodsError && !distributionDateError;\n\n  const validate = () => {\n    const dateValid = validateDate(distributionDate);\n    const addressValid = validateAddress(beneficiary);\n    const periodsValid = periodType === \"immediate\" ? true : validatePeriods(distributionPeriods);\n    return dateValid && addressValid && periodsValid;\n  };\n\n  const validateDate = value => {\n    try {\n      const items = value.split(\"/\");\n      const newDate = new Date(`${items[2]}/${items[0]}/${items[1]}`);\n      const now = new Date();\n      if (items.length !== 3) setDistributionDateError(\"Incorrect Date format\");else if (newDate < now) setDistributionDateError(\"Date must be in future\");else {\n        setDistributionDateError(\"\");\n        return true;\n      }\n    } catch {\n      setDistributionDateError(\"Incorrect Date format\");\n    }\n\n    return false;\n  };\n\n  const validateAddress = value => {\n    if (value.length !== 42) setAddressError(\"Invalid Address\");else {\n      setAddressError(\"\");\n      return true;\n    }\n    return false;\n  };\n\n  const validatePeriods = value => {\n    let periods = 0;\n\n    try {\n      periods = Number(value);\n      if (periods <= 0) setDistributionPeriodsError(\"Periods must be a positive number\");else if (periods === 1) setDistributionPeriodsError(\"For only one period, use an Immediate Capsule\");else {\n        setDistributionPeriodsError(\"\");\n        return true;\n      }\n    } catch {\n      setDistributionPeriodsError(\"Invalid Number\");\n    }\n\n    return false;\n  };\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(Popup, {\n      show: !complete,\n      close: props.close,\n      header: \"Create Capsule\",\n      content: /*#__PURE__*/_jsxDEV(Content, {\n        children: [/*#__PURE__*/_jsxDEV(Selector, {\n          options: [\"immediate\", \"staggered\"],\n          activeOption: periodType,\n          setOption: option => {\n            setPeriodType(option);\n            setDistributionPeriodsError(\"\");\n          },\n          label: \"Distribution Type\",\n          tooltip: \"An Immediate Capsule will open completely on the distribution date, allowing all crypto to be accessed at once. A Staggered Capsule will first open on the Distribution Start Date for a portion of the crypto, and more crypto will become accessible at the defined intervals\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 203,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(TextInput, {\n          label: periodType === \"immediate\" ? \"Distribution Date\" : \"Distribution Start Date\",\n          placeholder: \"mm/dd/yyyy\",\n          tooltip: periodType === \"immediate\" ? \"This is the date when the capsule will be able to be opened\" : \"This is the date when the capsule will first be able to be opened\",\n          value: distributionDate,\n          setValue: value => {\n            validateDate(value);\n            setDistributionDate(value);\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 213,\n          columnNumber: 13\n        }, this), distributionDateError && /*#__PURE__*/_jsxDEV(ValidationError, {\n          children: distributionDateError\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 232,\n          columnNumber: 15\n        }, this), periodType === \"staggered\" && /*#__PURE__*/_jsxDEV(_Fragment, {\n          children: [/*#__PURE__*/_jsxDEV(Dropdown, {\n            label: \"Distribution Frequency\",\n            tooltip: \"How often the crypto should be distributed to the beneficiary after the capsule is opened\",\n            options: [\"daily\", \"weekly\", \"monthly\", \"annually\"],\n            activeOption: distributionFrequency,\n            setOption: option => setDistributionFrequency(option)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 236,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(TextInput, {\n            label: \"Distribution Periods\",\n            placeholder: \"e.g. 12\",\n            tooltip: \"How many periods the crypto should be spread out over for the staggerd distribution\",\n            value: distributionPeriods,\n            setValue: value => {\n              validatePeriods(value);\n              setDistributionPeriods(value);\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 245,\n            columnNumber: 17\n          }, this), distributionPeriodsError && /*#__PURE__*/_jsxDEV(ValidationError, {\n            children: distributionPeriodsError\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 256,\n            columnNumber: 19\n          }, this)]\n        }, void 0, true), /*#__PURE__*/_jsxDEV(TextInput, {\n          label: \"Beneficiary\",\n          placeholder: \"e.g. 0x07d48BDBA7975f0DAF73BD5b85A2E3Ff87ffb24e\",\n          tooltip: \"This is the wallet address that your crypto will be sent to on the distribution date\",\n          value: beneficiary,\n          setValue: value => {\n            validateAddress(value);\n            setBeneficiary(value);\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 260,\n          columnNumber: 13\n        }, this), addressError && /*#__PURE__*/_jsxDEV(ValidationError, {\n          children: addressError\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 270,\n          columnNumber: 30\n        }, this), /*#__PURE__*/_jsxDEV(Selector, {\n          options: [\"yes\", \"no\"],\n          activeOption: addingAssetsAllowed,\n          setOption: option => setAddingAssetsAllowed(option),\n          label: \"Adding Assets Allowed\",\n          tooltip: \"Controls if you are able to continue to add assets to the capsule after it has been created. 'Yes' will mean you can keep adding assets after it has been created. 'No' means that you can only add assets once when it is created.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 271,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(Assets, {\n          assets: assets,\n          setAssets: assets => {\n            setAssets(assets);\n            updateApprovals(assets);\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 278,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 202,\n        columnNumber: 11\n      }, this),\n      buttonText: unapproved.length === 0 ? \"Create\" : `Approve ${addressSymbol(unapproved[0].asset.token)}`,\n      buttonAction: () => {\n        if (unapproved.length === 0) create();else tokenApprove(unapproved[0].asset.token);\n      },\n      loading: loading,\n      buttonDisabled: !isValid()\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 197,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Popup, {\n      show: complete,\n      close: props.close,\n      header: \"Capsule Created!\",\n      image: lockedCapsule,\n      body: \"Click below to view your capsule\",\n      buttonText: \"View Capsule\",\n      buttonAction: () => history.push(\"/sent\")\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 299,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n};\n\n_s(CreateCapsule, \"Ud60nysMaA7cU3uJepRzQNHeTu0=\", false, function () {\n  return [useHistory, useSelector];\n});\n\n_c2 = CreateCapsule;\nexport default CreateCapsule;\n\nvar _c, _c2;\n\n$RefreshReg$(_c, \"Content\");\n$RefreshReg$(_c2, \"CreateCapsule\");","map":{"version":3,"sources":["/Users/richard/Documents/GitHub/time_sapsule/client/src/components/CreateCapsule.tsx"],"names":["React","useState","BN","useSelector","styled","useHistory","gtag","lockedCapsule","createCapsule","getAssetLongValue","getTokenContract","tokenApproved","getPeriodSize","inputToDate","selectTokens","Assets","TextInput","Popup","ValidationError","Selector","Dropdown","getGlobals","Content","div","CreateCapsule","props","show","history","ethAsset","token","value","approval","asset","approved","loading","setLoading","complete","setComplete","beneficiary","setBeneficiary","distributionDate","setDistributionDate","periodType","setPeriodType","distributionFrequency","setDistributionFrequency","distributionPeriods","setDistributionPeriods","distributionDateError","setDistributionDateError","addingAssetsAllowed","setAddingAssetsAllowed","addressError","setAddressError","distributionPeriodsError","setDistributionPeriodsError","assets","setAssets","approvals","setApprovals","tokens","unapproved","filter","a","addressSymbol","address","symbol","updateApprovals","_approvals","promises","map","push","Promise","all","tokenApprove","globals","tokenContract","methods","approve","CAPSULE","send","on","hash","receipt","err","console","log","create","validate","_assets","Number","parseFloat","date","isValid","dateValid","validateDate","addressValid","validateAddress","periodsValid","validatePeriods","items","split","newDate","Date","now","length","periods","close","option"],"mappings":"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","sourcesContent":["import React, { useState } from \"react\";\nimport BN from \"bn.js\";\nimport { useSelector } from \"react-redux\";\nimport styled from \"styled-components\";\nimport { useHistory } from \"react-router\";\nimport { gtag } from \"@deptno/gtag\";\nimport lockedCapsule from \"../assets/capsule-locked-large.png\";\n\nimport {\n  createCapsule,\n  getAssetLongValue,\n  getTokenContract,\n  tokenApproved,\n} from \"../services/contracthelper\";\nimport { getPeriodSize, inputToDate } from \"../services/dateHelper\";\nimport { selectTokens } from \"../state/tokenSlice\";\nimport { Asset } from \"../types/CapsuleType\";\nimport Token from \"../types/Token\";\nimport Assets from \"./Assets\";\nimport TextInput from \"./TextInput\";\nimport Popup from \"./Popup\";\nimport { ValidationError } from \"../styles/ValidationError\";\nimport Selector from \"./Selector\";\nimport Dropdown from \"./Dropdown\";\nimport { getGlobals } from \"../utils/globals\";\n\ntype Approval = {\n  asset: Asset;\n  approved: boolean;\n};\n\nconst Content = styled.div`\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n`;\n\ntype Props = {\n  show: boolean;\n  close: () => void;\n};\n\nconst CreateCapsule = (props: Props): JSX.Element => {\n  if (!props.show) return <></>;\n\n  const history = useHistory();\n\n  const ethAsset: Asset = { token: \"ETH\", value: \"0\" };\n  const approval: Approval = { asset: ethAsset, approved: true };\n\n  const [loading, setLoading] = useState(false);\n  const [complete, setComplete] = useState(false);\n  const [beneficiary, setBeneficiary] = useState(\"\");\n  const [distributionDate, setDistributionDate] = useState(\"\");\n  const [periodType, setPeriodType] = useState(\"immediate\");\n  const [distributionFrequency, setDistributionFrequency] = useState(\"monthly\");\n  const [distributionPeriods, setDistributionPeriods] = useState(\"\");\n  const [distributionDateError, setDistributionDateError] = useState(\"\");\n  const [addingAssetsAllowed, setAddingAssetsAllowed] = useState(\"yes\");\n  const [addressError, setAddressError] = useState(\"\");\n  const [distributionPeriodsError, setDistributionPeriodsError] = useState(\"\");\n  const [assets, setAssets] = useState<Asset[]>([ethAsset]);\n  const [approvals, setApprovals] = useState<Approval[]>([approval]);\n\n  const tokens = useSelector(selectTokens);\n\n  const unapproved = approvals.filter((a: Approval) => !a.approved);\n\n  const addressSymbol = (address: string) =>\n    tokens.filter((token: Token) => token.address === address)[0].symbol;\n\n  const updateApprovals = async (assets: Asset[]) => {\n    const _approvals: Approval[] = [];\n    const promises = assets.map(async (asset: Asset) => {\n      _approvals.push({\n        asset,\n        approved: await tokenApproved(asset.token),\n      });\n    });\n    await Promise.all(promises);\n    setApprovals(_approvals);\n  };\n\n  const tokenApprove = async (address: string) => {\n    const globals = await getGlobals();\n    const tokenContract = await getTokenContract(address);\n    tokenContract.methods\n      .approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\"))\n      .send()\n      .on(\"transactionHash\", (hash: any) => {\n        setLoading(true);\n      })\n      .on(\"receipt\", async (receipt: any) => {\n        await updateApprovals(assets);\n        setLoading(false);\n      })\n      .on(\"error\", (err: any) => {\n        console.log(`Error: ${err}`);\n        setLoading(false);\n      });\n  };\n\n  const create = async () => {\n    if (!validate()) return;\n\n    setLoading(true);\n\n    const _assets: Asset[] = [];\n\n    const promises: Promise<void>[] = assets.map(async (asset: Asset) => {\n      _assets.push({\n        token: asset.token,\n        value: await getAssetLongValue(\n          Number.parseFloat(asset.value),\n          asset.token\n        ),\n      });\n    });\n\n    await Promise.all(promises);\n\n    const date = inputToDate(distributionDate);\n    await createCapsule(\n      beneficiary,\n      date,\n      getPeriodSize(distributionFrequency),\n      periodType === \"immediate\" ? 1 : Number(distributionPeriods),\n      _assets,\n      addingAssetsAllowed === \"yes\"\n    );\n\n    gtag(\"event\", \"created\");\n    gtag(\"event\", \"conversion\");\n    setComplete(true);\n  };\n\n  const isValid = (): boolean =>\n    !addressError && !distributionPeriodsError && !distributionDateError;\n\n  const validate = (): boolean => {\n    const dateValid = validateDate(distributionDate);\n    const addressValid = validateAddress(beneficiary);\n    const periodsValid =\n      periodType === \"immediate\" ? true : validatePeriods(distributionPeriods);\n    return dateValid && addressValid && periodsValid;\n  };\n\n  const validateDate = (value: string): boolean => {\n    try {\n      const items = value.split(\"/\");\n      const newDate = new Date(`${items[2]}/${items[0]}/${items[1]}`);\n      const now = new Date();\n      if (items.length !== 3) setDistributionDateError(\"Incorrect Date format\");\n      else if (newDate < now)\n        setDistributionDateError(\"Date must be in future\");\n      else {\n        setDistributionDateError(\"\");\n        return true;\n      }\n    } catch {\n      setDistributionDateError(\"Incorrect Date format\");\n    }\n    return false;\n  };\n\n  const validateAddress = (value: string): boolean => {\n    if (value.length !== 42) setAddressError(\"Invalid Address\");\n    else {\n      setAddressError(\"\");\n      return true;\n    }\n    return false;\n  };\n\n  const validatePeriods = (value: string): boolean => {\n    let periods = 0;\n    try {\n      periods = Number(value);\n      if (periods <= 0)\n        setDistributionPeriodsError(\"Periods must be a positive number\");\n      else if (periods === 1)\n        setDistributionPeriodsError(\n          \"For only one period, use an Immediate Capsule\"\n        );\n      else {\n        setDistributionPeriodsError(\"\");\n        return true;\n      }\n    } catch {\n      setDistributionPeriodsError(\"Invalid Number\");\n    }\n    return false;\n  };\n\n  return (\n    <>\n      <Popup\n        show={!complete}\n        close={props.close}\n        header=\"Create Capsule\"\n        content={\n          <Content>\n            <Selector\n              options={[\"immediate\", \"staggered\"]}\n              activeOption={periodType}\n              setOption={(option: string) => {\n                setPeriodType(option);\n                setDistributionPeriodsError(\"\");\n              }}\n              label=\"Distribution Type\"\n              tooltip=\"An Immediate Capsule will open completely on the distribution date, allowing all crypto to be accessed at once. A Staggered Capsule will first open on the Distribution Start Date for a portion of the crypto, and more crypto will become accessible at the defined intervals\"\n            />\n            <TextInput\n              label={\n                periodType === \"immediate\"\n                  ? \"Distribution Date\"\n                  : \"Distribution Start Date\"\n              }\n              placeholder=\"mm/dd/yyyy\"\n              tooltip={\n                periodType === \"immediate\"\n                  ? \"This is the date when the capsule will be able to be opened\"\n                  : \"This is the date when the capsule will first be able to be opened\"\n              }\n              value={distributionDate}\n              setValue={(value: string) => {\n                validateDate(value);\n                setDistributionDate(value);\n              }}\n            />\n            {distributionDateError && (\n              <ValidationError>{distributionDateError}</ValidationError>\n            )}\n            {periodType === \"staggered\" && (\n              <>\n                <Dropdown\n                  label=\"Distribution Frequency\"\n                  tooltip=\"How often the crypto should be distributed to the beneficiary after the capsule is opened\"\n                  options={[\"daily\", \"weekly\", \"monthly\", \"annually\"]}\n                  activeOption={distributionFrequency}\n                  setOption={(option: string) =>\n                    setDistributionFrequency(option)\n                  }\n                />\n                <TextInput\n                  label=\"Distribution Periods\"\n                  placeholder=\"e.g. 12\"\n                  tooltip=\"How many periods the crypto should be spread out over for the staggerd distribution\"\n                  value={distributionPeriods}\n                  setValue={(value: string) => {\n                    validatePeriods(value);\n                    setDistributionPeriods(value);\n                  }}\n                />\n                {distributionPeriodsError && (\n                  <ValidationError>{distributionPeriodsError}</ValidationError>\n                )}\n              </>\n            )}\n            <TextInput\n              label=\"Beneficiary\"\n              placeholder=\"e.g. 0x07d48BDBA7975f0DAF73BD5b85A2E3Ff87ffb24e\"\n              tooltip=\"This is the wallet address that your crypto will be sent to on the distribution date\"\n              value={beneficiary}\n              setValue={(value: string) => {\n                validateAddress(value);\n                setBeneficiary(value);\n              }}\n            />\n            {addressError && <ValidationError>{addressError}</ValidationError>}\n            <Selector\n              options={[\"yes\", \"no\"]}\n              activeOption={addingAssetsAllowed}\n              setOption={(option: string) => setAddingAssetsAllowed(option)}\n              label=\"Adding Assets Allowed\"\n              tooltip=\"Controls if you are able to continue to add assets to the capsule after it has been created. 'Yes' will mean you can keep adding assets after it has been created. 'No' means that you can only add assets once when it is created.\"\n            />\n            <Assets\n              assets={assets}\n              setAssets={(assets: Asset[]) => {\n                setAssets(assets);\n                updateApprovals(assets);\n              }}\n            />\n          </Content>\n        }\n        buttonText={\n          unapproved.length === 0\n            ? \"Create\"\n            : `Approve ${addressSymbol(unapproved[0].asset.token)}`\n        }\n        buttonAction={() => {\n          if (unapproved.length === 0) create();\n          else tokenApprove(unapproved[0].asset.token);\n        }}\n        loading={loading}\n        buttonDisabled={!isValid()}\n      />\n      <Popup\n        show={complete}\n        close={props.close}\n        header=\"Capsule Created!\"\n        image={lockedCapsule}\n        body=\"Click below to view your capsule\"\n        buttonText=\"View Capsule\"\n        buttonAction={() => history.push(\"/sent\")}\n      />\n    </>\n  );\n};\n\nexport default CreateCapsule;\n"]},"metadata":{},"sourceType":"module"}