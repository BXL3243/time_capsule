{"ast":null,"code":"import _regeneratorRuntime from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _taggedTemplateLiteral from\"/Users/richard/Documents/GitHub/time_capsule/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral\";var _templateObject;import React,{useState}from\"react\";import{useSelector}from\"react-redux\";import BN from\"bn.js\";import styled from\"styled-components\";import{addAssets,getTokenContract,tokenApproved}from\"../services/contracthelper\";import{selectTokens}from\"../state/tokenSlice\";import Assets from\"./Assets\";import Popup from\"./Popup\";import{getGlobals}from\"../utils/globals\";import{jsx as _jsx}from\"react/jsx-runtime\";var StyledAddAssets=styled.div(_templateObject||(_templateObject=_taggedTemplateLiteral([\"\\n  width: 100%;\\n\"])));var AddAssets=function AddAssets(props){var tokens=useSelector(selectTokens);var ethAsset={token:\"ETH\",value:\"0\"};var approval={asset:ethAsset,approved:true};var _useState=useState([ethAsset]),_useState2=_slicedToArray(_useState,2),assets=_useState2[0],_setAssets=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),loading=_useState4[0],setLoading=_useState4[1];var _useState5=useState([approval]),_useState6=_slicedToArray(_useState5,2),approvals=_useState6[0],setApprovals=_useState6[1];var unapproved=approvals.filter(function(a){return!a.approved;});var addressSymbol=function addressSymbol(address){return tokens.filter(function(token){return token.address===address;})[0].symbol;};var tokenApprove=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(address){var globals,tokenContract;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getGlobals();case 2:globals=_context2.sent;_context2.next=5;return getTokenContract(address);case 5:tokenContract=_context2.sent;tokenContract.methods.approve(globals.CAPSULE,new BN(\"9999999999999999999999999999\")).send().on(\"transactionHash\",function(hash){setLoading(true);}).on(\"receipt\",/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(receipt){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return updateApprovals(assets);case 2:setLoading(false);case 3:case\"end\":return _context.stop();}}},_callee);}));return function(_x2){return _ref2.apply(this,arguments);};}()).on(\"error\",function(err){console.log(\"Error: \".concat(err));setLoading(false);});case 7:case\"end\":return _context2.stop();}}},_callee2);}));return function tokenApprove(_x){return _ref.apply(this,arguments);};}();var updateApprovals=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(assets){var _approvals,promises;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_approvals=[];promises=assets.map(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(asset){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.t0=_approvals;_context3.t1=asset;_context3.next=4;return tokenApproved(asset.token);case 4:_context3.t2=_context3.sent;_context3.t3={asset:_context3.t1,approved:_context3.t2};_context3.t0.push.call(_context3.t0,_context3.t3);case 7:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x4){return _ref4.apply(this,arguments);};}());_context4.next=4;return Promise.all(promises);case 4:setApprovals(_approvals);case 5:case\"end\":return _context4.stop();}}},_callee4);}));return function updateApprovals(_x3){return _ref3.apply(this,arguments);};}();var click=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:setLoading(true);_context5.next=3;return addAssets(props.capsuleId,assets);case 3:setLoading(false);props.updateCapsules();props.close();case 6:case\"end\":return _context5.stop();}}},_callee5);}));return function click(){return _ref5.apply(this,arguments);};}();return/*#__PURE__*/_jsx(Popup,{show:props.show,close:props.close,header:\"Add Assets\",buttonText:unapproved.length===0?\"Add Assets\":\"Approve \".concat(addressSymbol(unapproved[0].asset.token)),buttonAction:function buttonAction(){if(unapproved.length===0)click();else tokenApprove(unapproved[0].asset.token);},loading:loading,content:/*#__PURE__*/_jsx(StyledAddAssets,{children:/*#__PURE__*/_jsx(Assets,{assets:assets,setAssets:function setAssets(assets){_setAssets(assets);updateApprovals(assets);}})})});};export default AddAssets;","map":{"version":3,"sources":["/Users/richard/Documents/GitHub/time_capsule/client/src/components/AddAssets.tsx"],"names":["React","useState","useSelector","BN","styled","addAssets","getTokenContract","tokenApproved","selectTokens","Assets","Popup","getGlobals","StyledAddAssets","div","AddAssets","props","tokens","ethAsset","token","value","approval","asset","approved","assets","setAssets","loading","setLoading","approvals","setApprovals","unapproved","filter","a","addressSymbol","address","symbol","tokenApprove","globals","tokenContract","methods","approve","CAPSULE","send","on","hash","receipt","updateApprovals","err","console","log","_approvals","promises","map","push","Promise","all","click","capsuleId","updateCapsules","close","show","length"],"mappings":"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","sourcesContent":["import React, { useState } from \"react\";\nimport { useSelector } from \"react-redux\";\nimport BN from \"bn.js\";\nimport styled from \"styled-components\";\n\nimport {\n  addAssets,\n  getTokenContract,\n  tokenApproved,\n} from \"../services/contracthelper\";\nimport { selectTokens } from \"../state/tokenSlice\";\nimport { Asset } from \"../types/CapsuleType\";\nimport Token from \"../types/Token\";\nimport Assets from \"./Assets\";\nimport Popup from \"./Popup\";\nimport { getGlobals } from \"../utils/globals\";\n\nconst StyledAddAssets = styled.div`\n  width: 100%;\n`;\n\ntype Approval = {\n  asset: Asset;\n  approved: boolean;\n};\n\ntype Props = {\n  capsuleId: number;\n  show: boolean;\n  close: () => void;\n  updateCapsules: () => void;\n};\n\nconst AddAssets = (props: Props): JSX.Element => {\n  const tokens = useSelector(selectTokens);\n\n  const ethAsset: Asset = { token: \"ETH\", value: \"0\" };\n  const approval: Approval = { asset: ethAsset, approved: true };\n\n  const [assets, setAssets] = useState<Asset[]>([ethAsset]);\n  const [loading, setLoading] = useState(false);\n  const [approvals, setApprovals] = useState<Approval[]>([approval]);\n\n  const unapproved = approvals.filter((a: Approval) => !a.approved);\n\n  const addressSymbol = (address: string) =>\n    tokens.filter((token: Token) => token.address === address)[0].symbol;\n\n  const tokenApprove = async (address: string) => {\n    const globals = await getGlobals();\n    const tokenContract = await getTokenContract(address);\n    tokenContract.methods\n      .approve(globals.CAPSULE, new BN(\"9999999999999999999999999999\"))\n      .send()\n      .on(\"transactionHash\", (hash: any) => {\n        setLoading(true);\n      })\n      .on(\"receipt\", async (receipt: any) => {\n        await updateApprovals(assets);\n        setLoading(false);\n      })\n      .on(\"error\", (err: any) => {\n        console.log(`Error: ${err}`);\n        setLoading(false);\n      });\n  };\n\n  const updateApprovals = async (assets: Asset[]) => {\n    const _approvals: Approval[] = [];\n    const promises = assets.map(async (asset: Asset) => {\n      _approvals.push({\n        asset,\n        approved: await tokenApproved(asset.token),\n      });\n    });\n    await Promise.all(promises);\n    setApprovals(_approvals);\n  };\n\n  const click = async () => {\n    setLoading(true);\n    await addAssets(props.capsuleId, assets);\n    setLoading(false);\n    props.updateCapsules();\n    props.close();\n  };\n\n  return (\n    <Popup\n      show={props.show}\n      close={props.close}\n      header=\"Add Assets\"\n      buttonText={\n        unapproved.length === 0\n          ? \"Add Assets\"\n          : `Approve ${addressSymbol(unapproved[0].asset.token)}`\n      }\n      buttonAction={() => {\n        if (unapproved.length === 0) click();\n        else tokenApprove(unapproved[0].asset.token);\n      }}\n      loading={loading}\n      content={\n        <StyledAddAssets>\n          <Assets\n            assets={assets}\n            setAssets={(assets: Asset[]) => {\n              setAssets(assets);\n              updateApprovals(assets);\n            }}\n          />\n        </StyledAddAssets>\n      }\n    />\n  );\n};\n\nexport default AddAssets;\n"]},"metadata":{},"sourceType":"module"}